<script>
    app.controller("loancollectionFormController",
        [
            "$rootScope",
            "$scope",
            "$http",
            "$stateParams",
            "$state",
            "entity",
            "FileUploader",
            function ($rootScope, $scope, $http, $stateParams, $state, entity, FileUploader) {

                $scope.form_id = $stateParams.id;

                $scope.form = {};

                /*上传文件大数组*/
                $scope.uploadVal = [];

                /*上传文件时传入*/
                $scope.actCode = null;

                /*上传文件夹*/
                $scope.subcategory = null;
                $scope.topcategory = null;

                $scope.modalMaxPhoto = null;

                /*所有的上传的行为*/
                $scope.canActs = [];

                /*附加费用*/
                $scope.feetypes = [];
                $scope.forms    = {};

                //还款规则
                $scope.repaymentMethodCode = "";

                $scope.feetypeProductShow = false;
                $scope.productShow        = false;

                /*对应的产品*/
                $scope.productVal  = null;
                $scope.product     = null;
                $scope.productList = [];

                /*所有有产品*/
                $scope.allProductList = [];


                //判断是否有订单 如果没有无法保存
                $scope.loancollectionSelf = null;


                /*
               * 初始化
               * */
                $scope.into = function () {



                    entity.getDetail("rest/loancollections/" + $stateParams.id, ["state", "files", "workflow", "feebackups"]).then(function (resResult) {

                        $scope.form = {};

                        /*上传文件大数组*/
                        $scope.uploadVal = [];

                        /*上传文件时传入*/
                        $scope.actCode = null;

                        /*上传文件夹*/
                        $scope.subcategory = null;
                        $scope.topcategory = null;

                        $scope.modalMaxPhoto = null;

                        /*所有的上传的行为*/
                        $scope.canActs = [];


                        $scope.form = resResult;


                        console.log($scope.form);

                        $scope.repaymentMethodCode = $scope.form.repaymentMethodCode;

                        $scope.getAllProduct($scope.repaymentMethodCode);


                        $scope.loancollectionSelf = resResult._links.self.href;

                        angular.forEach($scope.form.currentUserCanActList, function (val, key) {
                            if (val.actGroup === "FILE_OPERATE") {
                                $scope.canActs.push(val);
                            }
                        });

                        $scope.canActs = $scope.canActs.sort(function (a, b) {
                            return a.sort - b.sort;
                        });

                        angular.forEach($scope.canActs, function (val, key) {
                            val.actPhoto = [];
                        });

                        angular.forEach($scope.form.files._embeddedItems, function (val, key) {
                            angular.forEach($scope.canActs, function (val1, key1) {
                                if (val.actCode === val1.actCode) {
                                    val1.actPhoto.push(val)
                                }
                            });
                        });

                    });

                    /*所有有产品*/
                    $scope.allProductList = [];
                    entity.getList("/rest/departments/" + $rootScope.myinfo.department.id + "/products?sort=lastModifiedAt,desc",["repaymentAccount","capitalproduct","state"]).then(function (resResult) {
                        if (resResult) {
                            $scope.allProductList = resResult._embeddedItems;
                            console.log(resResult);
                        }
                    });

                };

                $scope.into();


                /*根据还款规则去获取对应的所有产品*/
                $scope.getAllProduct = function (val) {
                    if (val) {
                        $scope.productShow = true;

                        $scope.productList = [];
                        angular.forEach($scope.allProductList, function (val1, key1) {
                            if (val1.repaymentMethodCode === val) {
                                $scope.productList.push(val1);
                            }
                        });
                        console.log(val);
                        $scope.repaymentMethodCode = val;
                        $scope.productVal = $scope.productList[0];
                        $scope.getProduct($scope.productVal);

                    } else {

                        $scope.feetypeProductShow = false;
                        $scope.productShow        = false;
                    }
                };

                /*获取对应的的产品*/
                $scope.getProduct = function (val) {
                    if (val) {
                        $scope.feetypeProductShow = true;
                        $scope.product            = val;
                        $scope.feetypeFunction(val);
                    } else {
                        $scope.feetypeProductShow = false;
                    }
                };

                /*根据产品获取收费项目*/
                $scope.feetypeFunction = function (product) {

                    //获取所有费用项目
                    $scope.feetypes = [];
                    $scope.forms    = {};

                    entity.getList("rest/feetypes").then(function (resResult1) {
                        angular.forEach(resResult1._embeddedItems, function (val, key) {
                            if (val.type == "0") {
                                $scope.feetypes.push(val)
                            }
                        });

                        if ($scope.form.feebackups._embeddedItems.length > 0) {
                            //获取自己已经添加的收费项目
                            angular.forEach($scope.form.feebackups._embeddedItems, function (val, key) {
                                $scope.forms[val.feetypeCode]        = val;
                                $scope.forms[val.feetypeCode].update = true;
                            });
                        } else {

                            //获取自己已经添加的收费项目
                            entity.getList("rest/products/" + product.id, ["productstorefees"]).then(function (resResult2) {
                                angular.forEach(resResult2.productstorefees._embeddedItems, function (val, key) {
                                    $scope.forms[val.feetypeCode] = val;
                                });
                            });
//                            //获取自己已经添加的收费项目
//                            entity.getList("rest/productstorefees", ["product"]).then(function (resResult2) {
//                                angular.forEach(resResult2._embeddedItems, function (val, key) {
//                                    if (val.product.id === product.id) {
//                                        $scope.forms[val.feetypeCode] = val;
//                                    }
//                                });
//                            });
                        }
                    });
                };


                $scope.productChargeSave = function () {

                    $http({
                        url: $scope.form._links.self.href,
                        method: "PATCH",
                        data:{
                            product : $scope.product._links.self.href,
                            repaymentMethodCode : $scope.repaymentMethodCode
                        }
                    }).success(function (resResult) {
                        $rootScope.toasterSuccess("成功！", "修改成功！");
                    });

                    if ($scope.loancollectionSelf) {

                        /*收费项目保存*/
                        angular.forEach($scope.forms, function (val, key) {
                            if (val.periodNumber) {
                                if (val.feeAmount && val.feeRate) {
                                    val.feeAmount = null;
                                }

                                //feetype
                                val.feetype     = val.fee._links.self.href;
                                val.feetypeCode = key;

                                //product
                                val.product = $scope.loancollectionSelf;

                                val.loancollection = $scope.form._links.self.href;

                                //提交判断是否是修改还是新建
                                if (val.update == true) {
                                    $http({
                                        url: val._links.self.href,
                                        method: "PATCH",
                                        data: val
                                    }).success(function (resResult) {
//                                        $rootScope.toasterSuccess("成功！", "修改成功！");
                                    });
                                } else {
                                    $http.post("rest/feebackups", val).success(function (resResult) {
                                        if (resResult) {
//                                            $rootScope.toasterSuccess("成功！", "新建成功！");
                                            val.update = true;
                                            val.id = resResult.id


                                        }
                                    });
                                }
                            }
                        });
//                        console.log($scope.forms)
//                        $scope.feetypeFunction();
//                        $state.reload();

                        $state.go("workflowEntity.home.profile.info", {
                            id: $scope.form.id,
                            entity_key: "loancollection"
                        }, {reload: true});

                    } else {
                        $rootScope.toasterError("错误！", "请先新建产品")
                    }


                };

                $scope.productChargeDelete = function (fee) {
                    var id = $scope.forms[fee.feetypeCode].id;
                    if (fee) {
                        if ($scope.form.feebackups._embeddedItems.length > 0) {
                            $rootScope.sweetConfirm({
                                title: "提示",
                                text: "你是否要删除这条收费项目！",
                                type: "warning",
                                callback: function () {
                                    $scope.$apply(function(){
                                        $scope.forms;
                                        delete $scope.forms[fee.feetypeCode];
                                    });
                                    $http({
                                        method: "DELETE",
                                        url: "rest/feebackups/" + id
                                    }).success(function (resResult) {
                                        $rootScope.toasterInfo("成功！", "删除成功");
//                                        $state.reload();
                                    });
                                }
                            })
                        } else {
                            $rootScope.sweetConfirm({
                                title: "提示",
                                text: "你是否要删除这条收费项目！",
                                type: "warning",
                                callback: function () {
//                                    delete $scope.forms[fee.feetypeCode];
                                    $scope.$apply(function(){
                                        $scope.forms;
                                        delete $scope.forms[fee.feetypeCode];
                                    })
                                }
                            })
                        }
                    }
                };


//                $scope.getAllProduct($scope.repaymentMethodCode);


                /*
                * 保存操作
                * */
                $scope.loancollectionSave = function () {

                    delete $scope.form.workflow;
                    delete $scope.form.state;
                    delete $scope.form.files;

//                    if (!(/(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/.test( $scope.form.applyIdentityNo))){
//                        $rootScope.toasterError("错误","请输入正确的身份证号！")
//                        return;
//                    }

                    if (entity.getRegular("identity", $scope.form.applyIdentityNo)) {
                        $rootScope.toasterError("错误", "请输入正确的身份证号！");
                        return;
                    }

                    if (entity.getRegular("mobile", $scope.form.applyMobile)) {
                        $rootScope.toasterError("错误", "不是完整的11位手机号或者正确的手机号前七位！")
                        return;
                    }


                    $scope.form.act = "update";
                    $http({
                        url: $scope.form._links.self.href,
                        method: "PATCH",
                        data: $scope.form
                    }).success(function (resResult) {

//                        $state.go("workflowEntity.home.profile.info", {
//                            id: resResult.id,
//                            entity_key: "loancollection"
//                        }, {reload: true});

                        $rootScope.toasterSuccess("成功！", "修改成功！");
                    });
                };

                /*
                * 上传照片
                * */
                $scope.uploadPhoto = function (act) {

                    console.log(act);
                    $scope.actCode = act.actCode;

                    $scope.subcategory = act.subcategory;
                    $scope.topcategory = act.topcategory;

                    $scope.uploader.clearQueue();
                    $("#loancollection_upload").modal("show");
                };


                /*
                * 查看一张图片
                * */
                $scope.uploadOnePhoto = function (value) {
                    console.log(value);
                    $scope.modalMaxPhoto = value;
                    $("#loancollection_upload_one_photo").modal("show");
                };

                /*
                * 删除图片
                * */
                $scope.photoChargeDelete = function (fee) {
                    if (fee) {
                        $rootScope.sweetConfirm({
                            title: "提示",
                            text: "你是否要删除这张图片！",
                            type: "warning",
                            callback: function () {
                                $http({
                                    method: "GET",
                                    url: "/rest/loancollections/" + $scope.form_id + "/files"
                                }).success(function (resResult) {
                                    angular.forEach(resResult._embedded.loancollectionFiles, function (val, key) {
                                        if (val.newFileName == fee.newFileName) {
                                            $http({
                                                method: "DELETE",
//                                                url: "/rest/loancollections/" + $scope.form_id + "/files/" + val.id
                                                url: "/rest/loancollectionFiles/" + val.id + "/entity/" + $scope.form_id
                                            }).success(function (resResult) {
                                                $("#loancollection_upload_one_photo").modal("hide");
                                                $scope.into();
                                                $rootScope.toasterInfo("成功！", "删除成功");
                                            });
                                        }
                                    })
                                });

                            }
                        })
                    }
                };


                /*上传文件*/
                //以下是上传文件的动作详情参考前端框架示例 js/controllers/file-upload.js
                $scope.uploadDone = false;

                $scope.setUploadDone = function () {
                    $scope.uploadDone = false;
                };

                $scope.uploader = new FileUploader({
                    url: '/fileUpload'
                });

                $scope.uploader.filters.push({
                    name: 'customFilter',
                    fn: function (item, options) {
                        return this.queue.length < 30;
                    }
                });

                $scope.uploader.onAfterAddingFile = function (fileItem) {

                    if (fileItem.file.type.indexOf("image") !== -1) {
                        fileItem.formData    = [{fileType: "image"}];
                        fileItem.actCode     = $scope.actCode;
                        fileItem.subcategory = $scope.subcategory;
                        fileItem.topcategory = $scope.topcategory;

//                        fileItem.formData = [{fileType: "file"}];

                    } else {
                        $rootScope.toasterError("警告！", "只能上传图片格式请重新选择！");
                        fileItem.remove();

//                        fileItem.formData = [{fileType: "file"}]
                    }


//                    $("#audit_zip_file_input").val("");

                    console.log(fileItem);
                };

                $scope.uploader.onErrorItem = function (fileItem, response, status, headers) {
                    $rootScope.toasterError("上传失败！", fileItem.file.name + " 上传失败！");
                };

                $scope.uploader.onSuccessItem = function (fileItem, response, status, headers) {
                    $scope.uploadDone = true;

                    console.log(response);

                    response.result.actCode     = fileItem.actCode;
                    response.result.subcategory = fileItem.subcategory;
                    response.result.topcategory = fileItem.topcategory;

                    angular.forEach($scope.canActs, function (val, key) {
                        if (val.actCode == fileItem.actCode) {
                            val.actPhoto.push(response.result);
                        }
                    });

                    $http({
                        method: "PATCH",
                        url: "rest/loancollections/" + $scope.form_id,//这里是关联的实体
                        data: {
                            fileObject: response.result,//fileObject是上传完文件后的文件对象
                            act: fileItem.actCode//上传文件的行为
                        }
                    }).success(function (data) {
                        $rootScope.toasterSuccess("上传成功！", $scope.subcategory + "：" + fileItem.file.name + " 上传成功！");
                    });


                };


            }
        ]
    );
</script>
<!-- hbox layout -->
<div class="hbox hbox-auto-xs bg-light" ng-controller="loancollectionFormController">
    <!-- column -->
    <div class="col">
        <div class="wrapper b-b b-light">
            <div class="font-thin h4">
                <span translate="loancollection.self.label"></span>{{ form._links?"修改":"新建" }}
            </div>
        </div>

        <div class="wrapper">
            <tabset class="tab-container"
                    ng-init="steps={percent:50, step1:true, step2:false,step3:false}">
                <tab heading="1.基础信息" active="steps.step1" select="steps.percent=50">
                    <progressbar value="steps.percent" class="progress-xs" type="success"></progressbar>

                    <form name="step1" class="form-horizontal form-validation">

                        <div class="wrapper ng-scope">
                            <div class="row">
                                <div class="col-xs-12 col-sm-12">
                                    <div class="panel panel-info">
                                        <div class="panel-heading m-b">
                                            个人信息
                                        </div>

                                        <div class="form-group padder">
                                            <label class="col-sm-2 control-label">
                                                <span class="text-danger">*</span> <span
                                                    translate="loancollection.realName.label"></span>
                                            </label>
                                            <div class="col-xs-10">
                                                <input type="text"
                                                       class="form-control"
                                                       id="loancollection_realName"
                                                       name="loancollection_realName"
                                                       autocomplete="off"
                                                       required
                                                       ng-model="form.realName">
                                                <span class="help-block text-danger"
                                                      ng-show="step1.loancollection_realName.$invalid">
                                                      <i class="fa fa-exclamation-circle text-danger"></i>&ensp;姓名为必填
                                                </span>
                                            </div>
                                        </div>

                                        <div class="line line-dashed b-b line-lg"></div>
                                        <div class="form-group padder">
                                            <label class="col-sm-2 control-label">
                                                <span class="text-danger">*</span> <span
                                                    translate="loancollection.applyMobile.label"></span>
                                            </label>
                                            <div class="col-xs-10">
                                                <input type="text"
                                                       class="form-control"
                                                       autocomplete="off"
                                                       id="loancollection_applyMobile"
                                                       name="loancollection_applyMobile"
                                                       required
                                                       pattern="^(\+\d{2,3})?1(3|4|7|5|8)([0-9]{9})$"
                                                       ng-model="form.applyMobile">
                                                <span class="help-block text-danger"
                                                      ng-show="step1.loancollection_applyMobile.$invalid">
                                                      <i class="fa fa-exclamation-circle text-danger"></i>&ensp;请输入正确的手机号
                                                </span>
                                            </div>
                                        </div>

                                        <div class="line line-dashed b-b line-lg"></div>
                                        <div class="form-group padder">
                                            <label class="col-sm-2 control-label">
                                                <span class="text-danger">*</span> <span
                                                    translate="loancollection.applyIdentityNo.label"></span>
                                            </label>
                                            <div class="col-xs-10">
                                                <input class="form-control"
                                                       ng-model="form.applyIdentityNo"
                                                       id="loancollection_applyIdentityNo"
                                                       name="loancollection_applyIdentityNo"
                                                       required
                                                       pattern="(^\d{18}$)|(^\d{17}(\d|X|x)$)"
                                                       autocomplete="off"
                                                       type="text">
                                                <span class="help-block text-danger"
                                                      ng-show="step1.loancollection_applyIdentityNo.$invalid">
                                                      <i class="fa fa-exclamation-circle text-danger"></i>&ensp;请输入正确的身份证号
                                                </span>
                                            </div>
                                        </div>

                                        <div class="line line-dashed b-b line-lg"></div>
                                        <div class="form-group padder">
                                            <label class="col-sm-2 control-label"
                                                   translate="loancollection.sex.label"></label>
                                            <div class="col-xs-10 m-t-xs">
                                                <label class="i-checks m-r-sm">
                                                    <input type="radio" value="1" name="loancollectionSelectGender"
                                                           ng-model="form.sex">
                                                    <i></i>
                                                    男
                                                </label>
                                                <label class="i-checks m-r-sm">
                                                    <input type="radio" value="0" name="loancollectionSelectGender"
                                                           ng-model="form.sex">
                                                    <i></i>
                                                    女
                                                </label>

                                            </div>
                                        </div>

                                        <div class="line line-dashed b-b line-lg"></div>
                                        <div class="form-group padder">
                                            <label class="col-sm-2 control-label"
                                                   translate="loancollection.maritalStatus.self.label"></label>
                                            <div class="col-xs-10 m-t-xs">
                                                <label class="i-checks m-r-sm">
                                                    <input type="radio" value="MARRIED" name="loancollectionSelectMarital"
                                                           ng-model="form.maritalStatus">
                                                    <i></i>
                                                    已婚
                                                </label>
                                                <label class="i-checks m-r-sm">
                                                    <input type="radio" value="WIDOWED" name="loancollectionSelectMarital"
                                                           ng-model="form.maritalStatus">
                                                    <i></i>
                                                    丧偶
                                                </label>
                                                <label class="i-checks m-r-sm">
                                                    <input type="radio" value="DIVORCE" name="loancollectionSelectMarital"
                                                           ng-model="form.maritalStatus">
                                                    <i></i>
                                                    离异
                                                </label>
                                                <label class="i-checks m-r-sm">
                                                    <input type="radio" value="UNMARRIED" name="loancollectionSelectMarital"
                                                           ng-model="form.maritalStatus">
                                                    <i></i>
                                                    未婚
                                                </label>
                                            </div>
                                        </div>

                                        <div class="line line-dashed b-b line-lg"></div>
                                        <div class="form-group padder">
                                            <label class="col-sm-2 control-label"
                                                   translate="loancollection.email.label"></label>
                                            <div class="col-xs-10">
                                                <input class="form-control"
                                                       type="email"
                                                       ng-model="form.email">
                                            </div>
                                        </div>


                                        <div class="line line-dashed b-b line-lg"></div>
                                        <div class="form-group padder">
                                            <label class="col-sm-2 control-label">
                                                <span class="text-danger">*</span> <span
                                                    translate="loancollection.applyEnterpriseProvince.label"></span>
                                            </label>
                                            <div class="col-xs-10">
                                                <input type="text"
                                                       class="form-control"
                                                       id="loancollection_applyEnterpriseProvince"
                                                       name="loancollection_applyEnterpriseProvince"
                                                       ng-model="form.applyEnterpriseProvince"
                                                       required>
                                                <span class="help-block text-danger"
                                                      ng-show="step1.loancollection_applyEnterpriseProvince.$invalid">
                                                      <i class="fa fa-exclamation-circle text-danger"></i>&ensp;户籍为必填
                                                </span>
                                            </div>
                                        </div>

                                        <div class="line line-dashed b-b line-lg"></div>
                                        <div class="form-group padder">
                                            <label class="col-sm-2 control-label">
                                                <span class="text-danger">*</span> <span
                                                    translate="loancollection.applyBankCardBranch.label"></span>
                                            </label>
                                            <div class="col-xs-10">
                                                <input class="form-control"
                                                       ng-model="form.applyBankCardBranch"
                                                       id="loancollection_applyBankCardBranch"
                                                       name="loancollection_applyBankCardBranch"
                                                       type="text"
                                                       required>
                                                <span class="help-block text-danger"
                                                      ng-show="step1.loancollection_applyBankCardBranch.$invalid">
                                                      <i class="fa fa-exclamation-circle text-danger"></i>&ensp;储蓄卡支行为必填
                                                </span>
                                            </div>
                                        </div>

                                        <div class="line line-dashed b-b line-lg"></div>
                                        <div class="form-group padder">
                                            <label class="col-sm-2 control-label">
                                                <span class="text-danger">*</span> <span
                                                    translate="loancollection.applyBankCard.label"></span>
                                            </label>
                                            <div class="col-xs-10">
                                                <input type="text"
                                                       class="form-control"
                                                       id="loancollection_applyBankCard"
                                                       name="loancollection_applyBankCard"
                                                       ng-model="form.applyBankCard"
                                                       required
                                                       pattern="^[0-9]{19}$">
                                                <span class="help-block text-danger"
                                                      ng-show="step1.loancollection_applyBankCard.$invalid">
                                                      <i class="fa fa-exclamation-circle text-danger"></i>&ensp;储蓄卡卡号为19位数字，且必填
                                                </span>
                                            </div>
                                        </div>


                                        <div class="line line-dashed b-b line-lg"></div>
                                        <div class="form-group padder">
                                            <label class="col-sm-2 control-label"
                                                   translate="loancollection.personalAddress.label"></label>
                                            <div class="col-xs-10">
                                                <input class="form-control"
                                                       ng-model="form.personalAddress">
                                            </div>
                                        </div>

                                        <div class="line line-dashed b-b line-lg"></div>
                                        <div class="form-group padder">
                                            <label class="col-sm-2 control-label"
                                                   translate="loancollection.companyName.label"></label>
                                            <div class="col-xs-10">
                                                <input class="form-control"
                                                       ng-model="form.companyName">
                                            </div>
                                        </div>


                                        <div class="line line-dashed b-b line-lg"></div>
                                        <div class="form-group padder">
                                            <label class="col-sm-2 control-label"
                                                   translate="loancollection.companyTelephone.label"></label>
                                            <div class="col-xs-10">
                                                <input class="form-control"
                                                       ng-model="form.companyTelephone">
                                            </div>
                                        </div>


                                        <div class="line line-dashed b-b line-lg"></div>
                                        <div class="form-group padder">
                                            <label class="col-sm-2 control-label"
                                                   translate="loancollection.companyAddress.label"></label>
                                            <div class="col-xs-10">
                                                <input class="form-control"
                                                       ng-model="form.companyAddress">
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="wrapper ng-scope">
                            <div class="row">
                                <div class="col-xs-12 col-sm-12">
                                    <div class="panel panel-info">
                                        <div class="panel-heading m-b">
                                            贷款信息
                                        </div>
                                        <div class="form-group padder">
                                            <label class="col-sm-2 control-label">
                                                <span class="text-danger">*</span> <span
                                                    translate="loancollection.applyAmount.label"></span>
                                            </label>
                                            <div class="col-xs-10">
                                                <input type="text"
                                                       class="form-control"
                                                       id="loancollection_applyAmount"
                                                       name="loancollection_applyAmount"
                                                       ng-model="form.applyAmount"
                                                       required
                                                       pattern="^[0-9]+.?[0-9]*$">
                                                <span class="help-block text-danger"
                                                      ng-show="step1.loancollection_applyAmount.$invalid">
                                                      <i class="fa fa-exclamation-circle text-danger"></i>&ensp;借款总额为数字，且必填
                                                </span>
                                            </div>
                                        </div>

                                        <!--<div class="line line-dashed b-b line-lg"></div>-->
                                        <!--<div class="form-group padder">-->
                                        <!--<label class="col-sm-2 control-label">-->
                                        <!--<span class="text-danger">*</span> <span-->
                                        <!--translate="loancollection.applyPeriodNumber.label"></span>-->
                                        <!--</label>-->
                                        <!--<div class="col-xs-10">-->
                                        <!--<input type="text"-->
                                        <!--class="form-control"-->
                                        <!--id="loancollection_applyPeriodNumber"-->
                                        <!--name="loancollection_applyPeriodNumber"-->
                                        <!--ng-model="form.applyPeriodNumber"-->
                                        <!--required-->
                                        <!--pattern="^[0-9]+.?[0-9]*$">-->
                                        <!--<span class="help-block text-danger"-->
                                        <!--ng-show="step1.loancollection_applyPeriodNumber.$invalid">-->
                                        <!--<i class="fa fa-exclamation-circle text-danger"></i>&ensp;分期数为数字，且必填-->
                                        <!--</span>-->
                                        <!--</div>-->
                                        <!--</div>-->

                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="wrapper ng-scope">
                            <div class="row">
                                <div class="col-xs-12 col-sm-12">
                                    <div class="panel panel-info">
                                        <div class="panel-heading m-b">
                                            车辆信息
                                        </div>
                                        <div class="form-group padder">
                                            <label class="col-sm-2 control-label"
                                                   translate="loancollection.applyRegisterReigionName.label"></label>
                                            <div class="col-xs-10">
                                                <input class="form-control"
                                                       ng-model="form.applyRegisterReigionName">

                                            </div>
                                        </div>

                                        <div class="line line-dashed b-b line-lg"></div>
                                        <div class="form-group padder">
                                            <label class="col-sm-2 control-label">
                                                <span class="text-danger">*</span> <span
                                                    translate="loancollection.applyPlateNumber.label"></span>
                                            </label>
                                            <div class="col-xs-10">
                                                <input type="text"
                                                       class="form-control"
                                                       id="loancollection_applyPlateNumber"
                                                       name="loancollection_applyPlateNumber"
                                                       ng-model="form.applyPlateNumber"
                                                       required
                                                       pattern="^[京津沪渝冀豫云辽黑湘皖鲁新苏浙赣鄂桂甘晋蒙陕吉闽贵粤青藏川宁琼使领A-Za-z]{1}[A-Za-z]{1}[A-Za-z0-9]{4}[A-Za-z0-9挂学警港澳]{1}$">
                                                <span class="help-block text-danger"
                                                      ng-show="step1.loancollection_applyPlateNumber.$invalid">
                                                      <i class="fa fa-exclamation-circle text-danger"></i>&ensp;请输入正确的车牌号
                                                </span>
                                            </div>
                                        </div>

                                        <div class="line line-dashed b-b line-lg"></div>
                                        <div class="form-group padder">
                                            <label class="col-sm-2 control-label">
                                                <span class="text-danger">*</span> <span
                                                    translate="loancollection.applyVehicleModel.label"></span>
                                            </label>
                                            <div class="col-xs-10">
                                                <input type="text"
                                                       class="form-control"
                                                       ng-model="form.applyVehicleModel"
                                                       id="loancollection_applyVehicleModel"
                                                       name="loancollection_applyVehicleModel"
                                                       required>
                                                <span class="help-block text-danger"
                                                      ng-show="step1.loancollection_applyVehicleModel.$invalid">
                                                    <i class="fa fa-exclamation-circle text-danger"></i>&ensp;车辆型号为必填
                                                </span>
                                            </div>
                                        </div>

                                        <div class="line line-dashed b-b line-lg"></div>
                                        <div class="form-group padder">
                                            <label class="col-sm-2 control-label">
                                                <!--<span class="text-danger">*</span>-->
                                                <span translate="loancollection.applyAnnualSurveyMaturity.label"></span>
                                            </label>
                                            <div class="col-xs-10">
                                                <input class="form-control"
                                                       name="loancollection_applyAnnualSurveyMaturity"
                                                       placeholder="例如1949-10-01"
                                                       ng-model="form.applyAnnualSurveyMaturity"

                                                       pattern="^(?:(?!0000)[0-9]{4}-(?:(?:0[1-9]|1[0-2])-(?:0[1-9]|1[0-9]|2[0-8])|(?:0[13-9]|1[0-2])-(?:29|30)|(?:0[13578]|1[02])-31)|(?:[0-9]{2}(?:0[48]|[2468][048]|[13579][26])|(?:0[48]|[2468][048]|[13579][26])00)-02-29)$">
                                                <span class="help-block text-danger"
                                                      ng-show="step1.loancollection_applyAnnualSurveyMaturity.$invalid">
                                                    <i class="fa fa-exclamation-circle text-danger"></i>&ensp;请输入正确的格式如1949-10-01，此项必填
                                                </span>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="col-xs-10 col-xs-offset-2">
                                <button ui-sref="workflowEntity.home.profile.info({id:id,entity_key:'loancollection'})"
                                        class="btn btn-default btn-rounded">
                                    返回
                                </button>
                                <!--<button ng-if="!form._links"-->
                                <!--ui-sref="workflowEntity.list({entity_key:'loancollection',workflow_id:form.workflow.id})"-->
                                <!--class="btn btn-default btn-rounded">-->
                                <!--返回-->
                                <!--</button>-->
                                <button type="submit" ng-disabled="step1.$invalid"
                                        class="btn btn-default btn-rounded" ng-click="loancollectionSave()">基础信息保存
                                </button>

                                <button type="submit" ng-disabled="step1.$invalid"
                                        class="btn btn-default btn-rounded" ng-click="steps.step2=true">下一步
                                </button>
                            </div>
                        </div>

                    </form>
                </tab>


                <tab heading="2.图片上传" disabled="step1.$invalid" active="steps.step2"
                     select="steps.percent=50">
                    <form name="step2" class="form-horizontal form-validation">
                        <!--<p class="m-b">图片上传</p>-->
                        <progressbar value="steps.percent" class="progress-xs" type="success"></progressbar>

                        <div class="form-group" ng-repeat="act in canActs">
                            <label class="col-xs-2 control-label">{{ act.label }}</label>
                            <div class="col-xs-10">
                                <!--<span class="inline upload-photo-img m-r-xs m-t-xs"-->
                                <!--ng-repeat="photo in uploadVal"-->
                                <!--ng-click="uploadOnePhoto(photo[act.actCode])">-->
                                <!--<img class="upload-img "-->
                                <!--ng-if="photo.actCode=act.actCode?true:false"-->
                                <!--ng-src="http://files.xiaojinpingtai.com/{{  photo[act.actCode].result.newFileName }}"-->
                                <!--alt="">-->
                                <!--</span>-->
                                <span class="inline upload-photo-img m-r-xs m-t-xs"
                                      ng-repeat="photo in act.actPhoto"
                                      ng-click="uploadOnePhoto(photo)">
                                                <img class="upload-img "
                                                     ng-src="http://files.xiaojinpingtai.com/{{  photo.newFileName }}"
                                                     alt="">
                                </span>
                                <span class="inline upload-photo m-t-xs" ng-click="uploadPhoto(act)">
                                    <span class="block font-24">{{ act.label }}</span>
                                    <i class="fa fa-cloud-upload fa-4x" aria-hidden="true"></i>
                                </span>
                            </div>
                        </div>
                        <div class="line line-dashed b-b line-lg pull-in "></div>


                        <div class="form-group">
                            <div class="col-xs-2"></div>
                            <div class="col-xs-10">
                                <button type="button" class="btn btn-default btn-rounded m-r-xs"
                                        ng-click="steps.step1=true">上一步
                                </button>
                                <button type="submit"
                                        class="btn btn-default btn-rounded" ng-click="steps.step3=true">下一步
                                </button>
                            </div>

                        </div>
                    </form>
                </tab>


                <tab heading="3.匹配销售产品" disabled="step2.$invalid" active="steps.step3"
                     select="steps.percent=50">
                    <form name="step2" class="form-horizontal form-validation">
                        <progressbar value="steps.percent" class="progress-xs" type="success"></progressbar>

                        <div class="wrapper ng-scope">
                            <div class="row">
                                <div class="col-xs-12 col-sm-12">
                                    <div class="panel panel-info">
                                        <div class="panel-heading m-b">
                                            销售产品
                                        </div>
                                        <div class="panel-body">
                                            <div class="form-group">
                                                <div class="col-sm-5 ">
                                                    <select class="form-control m-b"
                                                            ng-model="repaymentMethodCode"
                                                            ng-change="getAllProduct(repaymentMethodCode)">
                                                        <option value="AVERAGE_CAPITAL">等额本金</option>
                                                        <option value="AVERAGE_CAPITAL_PLUS_INTEREST">等额本息</option>
                                                        <option value="BEFORE_INTEREST_AFTER_PRINCIPAL">先息后本</option>
                                                        <option value="LEND_REPAY_ON_DEMAND">随借随还</option>
                                                    </select>
                                                </div>
                                                <div class="col-xs-7" ng-if="productShow">
                                                    <select class="form-control m-b"
                                                            ng-options="product.label for product in productList"
                                                            ng-model="productVal"
                                                            ng-change="getProduct(productVal)"
                                                    >
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="panel panel-info padder" ng-if="feetypeProductShow">
                                                <table class="table table-striped m-b-none">
                                                    <tbody>
                                                    <tr>
                                                        <td class="v-middle text-right">
                                                            <span translate="product.label.label"></span>：
                                                        </td>
                                                        <td class="v-middle b-r">{{ product.label }}</td>
                                                        <td class="v-middle text-right">
                                                            <span translate="product.state.label"></span>：
                                                        </td>
                                                        <td class="v-middle">{{ product.state.label }}</td>
                                                    </tr>
                                                    <tr>
                                                        <td class="v-middle text-right">
                                                            <span translate="product.storeInterest.label"></span>：
                                                        </td>
                                                        <td class="v-middle b-r">{{ product.storeInterest }}</td>
                                                        <td class="v-middle text-right">
                                                            <span translate="product.debtorInterest.label"></span>：
                                                        </td>
                                                        <td class="v-middle">{{ product.debtorInterest }}</td>
                                                    </tr>

                                                    <tr>
                                                        <td class="v-middle text-right">
                                                            <span translate="product.storeAmountMin.label"></span>：
                                                        </td>
                                                        <td class="v-middle b-r">{{ product.storeAmountMin }}</td>
                                                        <td class="v-middle text-right">
                                                            <span translate="product.storeAmountMax.label"></span>：
                                                        </td>
                                                        <td class="v-middle">{{ product.storeAmountMax }}</td>
                                                    </tr>
                                                    <tr>
                                                        <td class="v-middle text-right">
                                                            <span translate="product.capitalproduct.label"></span>：
                                                        </td>
                                                        <td class="v-middle b-r">{{ product.capitalproduct.label }}</td>
                                                        <td class="v-middle text-right">
                                                            <span translate="product.repaymentAccount.label"></span>：
                                                        </td>
                                                        <td class="v-middle">{{ product.repaymentAccount.description }}</td>
                                                    </tr>
                                                    <tr>
                                                        <td class="v-middle text-right">
                                                            <span translate="product.description.label"></span>：
                                                        </td>
                                                        <td class="v-middle b-r">{{ product.description }}</td>
                                                        <td class="v-middle text-right">
                                                            <span>分期数</span>：
                                                        </td>
                                                        <td class="v-middle b-r">{{ product.capitalproduct.periodNumber
                                                            }}
                                                        </td>

                                                    </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="panel panel-info padder" ng-if="feetypeProductShow">
                                                <div class="panel-body">
                                                    <table class="table table-hover b-light"
                                                           style="border-bottom: none;">
                                                        <thead>
                                                        <tr>
                                                            <th></th>
                                                            <th>收费项目名称</th>
                                                            <th>
                                                                <span class="text-danger">*</span>
                                                                分期数
                                                            </th>
                                                            <th>
                                                                <span class="text-danger">*</span>
                                                                按比例收费(优先)
                                                            </th>
                                                            <th>
                                                                <span class="text-danger">*</span>
                                                                固定收费
                                                            </th>
                                                            <th>
                                                                <span class="text-danger">*</span>
                                                                描述
                                                            </th>
                                                            <th>
                                                                <span class="text-danger">*</span>
                                                                说明
                                                            </th>
                                                            <th>操作</th>
                                                        </tr>
                                                        </thead>
                                                        <tbody>
                                                        <tr ng-repeat="fee in feetypes">
                                                            <td class="v-middle">

                                                            </td>
                                                            <td class="v-middle">
                                                                {{ fee.label }}
                                                            </td>
                                                            <td class="v-middle">
                                                                <input type="text"
                                                                       ng-model="forms[fee.feetypeCode].periodNumber"
                                                                       class="form-control"
                                                                >
                                                            </td>
                                                            <td class="v-middle">
                                                                <input type="text"
                                                                       ng-model="forms[fee.feetypeCode].feeRate"
                                                                       class="form-control"
                                                                >
                                                            </td>
                                                            <td class="v-middle">
                                                                <input type="text"
                                                                       ng-model="forms[fee.feetypeCode].feeAmount"
                                                                       class="form-control"
                                                                >
                                                            </td>
                                                            <td class="v-middle">
                                                                <input type="text"
                                                                       ng-model="forms[fee.feetypeCode].description"
                                                                       class="form-control"
                                                                >
                                                            </td>
                                                            <td class="v-middle">
                                                                <input type="text"
                                                                       ng-model="forms[fee.feetypeCode].comment"
                                                                       class="form-control"
                                                                >
                                                                <span style="display: none">
                                                                   {{ forms[fee.feetypeCode].fee = fee }}
                                                                </span>
                                                            </td>
                                                            <td class="text-center v-middle">
                                                                <button class="btn btn-danger"
                                                                        ng-click="productChargeDelete(forms[fee.feetypeCode])">
                                                                   删除
                                                                </button>
                                                            </td>
                                                        </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="col-xs-2"></div>
                            <div class="col-xs-10">
                                <button type="button" class="btn btn-default btn-rounded m-r-xs"
                                        ng-click="steps.step2=true">上一步
                                </button>
                                <button type="submit"
                                        class="btn btn-default btn-rounded" ng-click="productChargeSave()">销售产品保存
                                </button>
                            </div>

                        </div>
                    </form>
                </tab>
            </tabset>


            <div class="modal fade" id="loancollection_upload">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close"
                                    ng-click="uploader.clearQueue();setUploadDone();"
                                    data-dismiss="modal">
                                <span>&times;</span>
                            </button>
                            <!--上传审核通过的文件-->
                            上传文件
                        </div>
                        <div class="modal-body">
                            <div class="hbox hbox-auto-xs hbox-auto-sm" nv-file-drop="" uploader="uploader"
                                 filters="queueLimit, customFilter">
                                <div class="col w-lg bg-light b-r bg-auto">
                                    <div class="wrapper-md dker b-b">
                                        <h4 class="m-n font-thin">选择文件</h4>
                                    </div>
                                    <div class="wrapper-md">
                                        <div ng-show="uploader.isHTML5" class="m-b-md">
                                            <!-- 3. nv-file-over uploader="link" over-class="className" -->
                                            <div class="b-a b-2x b-dashed wrapper-lg bg-white text-center m-b"
                                                 nv-file-over="" over-class="b-info" uploader="uploader">
                                                拖动文件放到此处
                                            </div>
                                        </div>
                                        <input id="audit_zip_file_input" class="w" type="file"
                                               nv-file-select=""
                                               multiple
                                               uploader="uploader"/>
                                    </div>
                                </div>
                                <div class="col bg-light bg-auto">
                                    <div class="wrapper-md bg-light dk b-b">
                                                    <span class="pull-right">文件数：
                                                        <b class="badge bg-info">{{ uploader.queue.length }}</b>
                                                    </span>
                                        <h4 class="m-n font-thin text-danger ">文件上传</h4>
                                    </div>
                                    <div class="wrapper-md">
                                        <table class="table bg-white-only b-a">
                                            <thead>
                                            <tr>
                                                <th>文件名</th>
                                                <th ng-show="uploader.isHTML5">大小</th>
                                                <th>状态</th>
                                                <th>操作</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            <tr ng-repeat="item in uploader.queue">
                                                <td>
                                                    <div class="text-ellipsis w-sm">{{ item.file.name }}
                                                    </div>
                                                </td>
                                                <td ng-show="uploader.isHTML5" nowrap>{{
                                                    item.file.size/1024/1024|number:2
                                                    }} MB
                                                </td>
                                                <td class="text-center">
                                                    <span ng-show="item.isSuccess" class="text-success">
                                                        <i class="fa fa-check"></i>
                                                    </span>
                                                    <span ng-show="item.isCancel" class="text-warning">
                                                        <i class="fa fa-ban"></i>
                                                    </span>
                                                    <span ng-show="item.isError" class="text-danger">
                                                        <i class="fa fa-cancel"></i>
                                                    </span>
                                                </td>
                                                <td nowrap>
                                                    <button type="button" class="btn btn-default btn-xs"
                                                            ng-click="item.upload()"
                                                            ng-disabled="item.isReady || item.isUploading || item.isSuccess">
                                                        上传
                                                    </button>
                                                    <button type="button" class="btn btn-default btn-xs" ng-disabled="item.isReady || item.isUploading || item.isSuccess"
                                                            ng-click="item.remove();setUploadDone();">
                                                        清除
                                                    </button>
                                                </td>
                                            </tr>
                                            </tbody>
                                        </table>
                                        <div>
                                            <div>
                                                <p>进度</p>
                                                <div class="progress bg-light dker" style="">
                                                    <div class="progress-bar progress-bar-striped bg-info"
                                                         role="progressbar"
                                                         ng-style="{ 'width': uploader.progress + '%' }"></div>
                                                </div>
                                                <div class="m-t m-b font-bold h4 text-danger"
                                                     ng-if="uploader.progress === 100 && !uploadDone">
                                                    服务器正在处理中，请稍等。。。
                                                </div>
                                            </div>
                                            <button type="button" class="btn btn-addon btn-success"
                                                    ng-click="uploader.uploadAll()"
                                                    ng-disabled="!uploader.getNotUploadedItems().length">
                                                <i class="fa fa-arrow-circle-o-up"></i> 上传
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="loancollection_upload_one_photo" tabindex="-1" role="dialog">
                <div class="modal-lg modal-dialog" role="document" style="width: 900px">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal"
                                    aria-label="Close">
                                <span aria-hidden="true">×</span>
                            </button>
                            <h4 class="modal-title">放大图片</h4>
                        </div>
                        <div class="modal-body" style="text-align: center">
                            <img ng-src="http://files.xiaojinpingtai.com/{{ modalMaxPhoto.newFileName }}"
                                 style="max-width: 750px;max-height: 650px;"
                                 alt="">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-danger"
                                    ng-click="photoChargeDelete(modalMaxPhoto)">
                                删除
                            </button>
                            <button type="button" class="btn btn-primary"
                                    ng-click="">
                                退出
                            </button>
                        </div>
                    </div>
                </div>
            </div>


        </div>

    </div>
</div>
<!-- /column -->
</div>
<!-- /hbox layout -->