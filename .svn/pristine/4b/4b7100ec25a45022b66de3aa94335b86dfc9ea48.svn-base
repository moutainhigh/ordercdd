module.exports=function(){var a={};var b={login:function(c,e,d){},syncMsgs:function(d,c){},getC2CHistoryMsgs:function(c,e,d){},syncGroupMsgs:function(c,e,d){},sendMsg:function(d,e,c){},logout:function(d,c){},setAutoRead:function(d,e,c){},getProfilePortrait:function(c,e,d){},setProfilePortrait:function(c,e,d){},applyAddFriend:function(c,e,d){},getPendency:function(c,e,d){},deletePendency:function(c,e,d){},responseFriend:function(c,e,d){},getAllFriend:function(c,e,d){},deleteFriend:function(c,e,d){},addBlackList:function(c,e,d){},getBlackList:function(c,e,d){},deleteBlackList:function(c,e,d){},uploadPic:function(c,e,d){},createGroup:function(c,e,d){},applyJoinGroup:function(c,e,d){},handleApplyJoinGroup:function(c,e,d){},deleteApplyJoinGroupPendency:function(c,e,d){},quitGroup:function(c,e,d){},getGroupPublicInfo:function(c,e,d){},getGroupInfo:function(c,e,d){},modifyGroupBaseInfo:function(c,e,d){},destroyGroup:function(c,e,d){},getJoinedGroupListHigh:function(c,e,d){},getGroupMemberInfo:function(c,e,d){},addGroupMember:function(c,e,d){},modifyGroupMember:function(c,e,d){},forbidSendMsg:function(c,e,d){},deleteGroupMember:function(c,e,d){},sendCustomGroupNotify:function(c,e,d){},Msg:function(e,j,d,f,g,c,i,h){},MsgStore:{sessMap:function(){return{}},sessCount:function(){return 0},sessByTypeId:function(c,d){return{}},delSessByTypeId:function(c,d){return true},resetCookieAndSyncFlag:function(){},downloadMap:{}}};(function(aV){var i={VERSION:"1.7.0",APPID:"537048168"};var w=true;var bE={FORMAL:{COMMON:"https://webim.tim.qq.com",PIC:"https://pic.tim.qq.com"},TEST:{COMMON:"https://test.tim.qq.com",PIC:"https://pic.tim.qq.com"}};var a8={};var bs=false;var bv={OPEN_IM:"openim",GROUP:"group_open_http_svc",FRIEND:"sns",PROFILE:"profile",RECENT_CONTACT:"recentcontact",PIC:"openpic",BIG_GROUP:"group_open_http_noauth_svc",BIG_GROUP_LONG_POLLING:"group_open_long_polling_http_noauth_svc",IM_OPEN_STAT:"imopenstat"};var O={openim:"v4",group_open_http_svc:"v4",sns:"v4",profile:"v4",recentcontact:"v4",openpic:"v4",group_open_http_noauth_svc:"v1",group_open_long_polling_http_noauth_svc:"v1",imopenstat:"v4"};var a4={login:1,pic_up:3,apply_join_group:9,create_group:10,longpolling:18,send_group_msg:19,sendmsg:20};var Y={C2C:"C2C",GROUP:"GROUP"};var bc={C2C:1,GROUP:2};var bD={C2C:12000,GROUP:8898};var v={OK:"OK",FAIL:"FAIL"};var k=99999;var aK={TEXT:"TIMTextElem",FACE:"TIMFaceElem",IMAGE:"TIMImageElem",CUSTOM:"TIMCustomElem",SOUND:"TIMSoundElem",FILE:"TIMFileElem",LOCATION:"TIMLocationElem",GROUP_TIP:"TIMGroupTipElem"};var aG={ORIGIN:1,LARGE:2,SMALL:3};var a3={RAW_DATA:0,BASE64_DATA:1};var bI={BUSSINESS_ID:"10001",AUTH_KEY:"617574686b6579",SERVER_IP:"182.140.186.147"};var J={SOUND:2106,FILE:2107};var P={IMAGE:1,FILE:2,SHORT_VIDEO:3,SOUND:4};var ac={APP_VERSION:"2.1",SERVER_VERSION:1};var aP={C2C:1,GROUP_COMMON:3,GROUP_TIP:4,GROUP_SYSTEM:5,GROUP_TIP2:6,FRIEND_NOTICE:7,PROFILE_NOTICE:8,C2C_COMMON:9,C2C_EVENT:10};var a1={COMMON:0};var Q={READED:92};var aH={COMMON:0,LOVEMSG:1,TIP:2,REDPACKET:3};var z={REDPACKET:1,COMMON:2,LOVEMSG:3};var h={JOIN:1,QUIT:2,KICK:3,SET_ADMIN:4,CANCEL_ADMIN:5,MODIFY_GROUP_INFO:6,MODIFY_MEMBER_INFO:7};var aU={FACE_URL:1,NAME:2,OWNER:3,NOTIFICATION:4,INTRODUCTION:5};var K={JOIN_GROUP_REQUEST:1,JOIN_GROUP_ACCEPT:2,JOIN_GROUP_REFUSE:3,KICK:4,DESTORY:5,CREATE:6,INVITED_JOIN_GROUP_REQUEST:7,QUIT:8,SET_ADMIN:9,CANCEL_ADMIN:10,REVOKE:11,READED:15,CUSTOM:255};var au={FRIEND_ADD:1,FRIEND_DELETE:2,PENDENCY_ADD:3,PENDENCY_DELETE:4,BLACK_LIST_ADD:5,BLACK_LIST_DELETE:6,PENDENCY_REPORT:7,FRIEND_UPDATE:8};var aS={PROFILE_MODIFY:1};var bF={OK:0,SIGNATURE_EXPIRATION:11};var at={INIT:-1,ON:0,RECONNECT:1,OFF:9999};var bq={GROUP_MSG:1,C2C_MSG:2,USER_HEAD:3,GROUP_HEAD:4};var p={ING:14,STOP:15};var X=15000;var aL=1000;var a5=5000;var N=10;var ad=at.INIT;var E=false;var aI=0;var g=60000;var n=5000;var ai=60008;var f=91101;var ak=null;var aB=0;var a9=10;var ap=0;var aR=20;var R=0;var av=null;var a7=null;var A=0;var br=[];var bj=null;var d=null;var bH={};var bw={sdkAppID:null,appIDAt3rd:null,accountType:null,identifier:null,tinyid:null,identifierNick:null,userSig:null,a2:null,contentType:"json",apn:1};var C={};var ah=0;var a6={};var az=0;var bt=[];var bG=[];var bA=20;var q=[];var bx={downloadMap:{}};var bo={"[惊讶]":0,"[撇嘴]":1,"[色]":2,"[发呆]":3,"[得意]":4,"[流泪]":5,"[害羞]":6,"[闭嘴]":7,"[睡]":8,"[大哭]":9,"[尴尬]":10,"[发怒]":11,"[调皮]":12,"[龇牙]":13,"[微笑]":14,"[难过]":15,"[酷]":16,"[冷汗]":17,"[抓狂]":18,"[吐]":19,"[偷笑]":20,"[可爱]":21,"[白眼]":22,"[傲慢]":23,"[饿]":24,"[困]":25,"[惊恐]":26,"[流汗]":27,"[憨笑]":28,"[大兵]":29,"[奋斗]":30,"[咒骂]":31,"[疑问]":32,"[嘘]":33,"[晕]":34};var bn={};var af=new function(){this.formatTimeStamp=function(bN,bO){if(!bN){return 0}var bQ;bO=bO||"yyyy-MM-dd hh:mm:ss";var bM=new Date(bN*1000);var bP={"M+":bM.getMonth()+1,"d+":bM.getDate(),"h+":bM.getHours(),"m+":bM.getMinutes(),"s+":bM.getSeconds()};if(/(y+)/.test(bO)){bQ=bO.replace(RegExp.$1,(bM.getFullYear()+"").substr(4-RegExp.$1.length))}else{bQ=bO}for(var bL in bP){if(new RegExp("("+bL+")").test(bQ)){bQ=bQ.replace(RegExp.$1,(RegExp.$1.length==1)?(bP[bL]):(("00"+bP[bL]).substr((""+bP[bL]).length)))}}return bQ};this.groupTypeEn2Ch=function(bL){var bM=null;switch(bL){case"Public":bM="公开群";break;case"ChatRoom":bM="聊天室";break;case"Private":bM="讨论组";break;case"AVChatRoom":bM="直播聊天室";break;default:bM=bL;break}return bM};this.groupTypeCh2En=function(bM){var bL=null;switch(bM){case"公开群":bL="Public";break;case"聊天室":bL="ChatRoom";break;case"讨论组":bL="Private";break;case"直播聊天室":bL="AVChatRoom";break;default:bL=bM;break}return bL};this.groupRoleEn2Ch=function(bL){var bM=null;switch(bL){case"Member":bM="成员";break;case"Admin":bM="管理员";break;case"Owner":bM="群主";break;default:bM=bL;break}return bM};this.groupRoleCh2En=function(bM){var bL=null;switch(bM){case"成员":bL="Member";break;case"管理员":bL="Admin";break;case"群主":bL="Owner";break;default:bL=bM;break}return bL};this.groupMsgFlagEn2Ch=function(bL){var bM=null;switch(bL){case"AcceptAndNotify":bM="接收并提示";break;case"AcceptNotNotify":bM="接收不提示";break;case"Discard":bM="屏蔽";break;default:bM=bL;break}return bM};this.groupMsgFlagCh2En=function(bM){var bL=null;switch(bM){case"接收并提示":bL="AcceptAndNotify";break;case"接收不提示":bL="AcceptNotNotify";break;case"屏蔽":bL="Discard";break;default:bL=bM;break}return bL};this.formatText2Html=function(bM){var bL=bM;if(bL){bL=this.xssFilter(bL);bL=bL.replace(/ /g,"&nbsp;");bL=bL.replace(/\n/g,"<br/>")}return bL};this.formatHtml2Text=function(bL){var bM=bL;if(bM){bM=bM.replace(/&nbsp;/g," ");bM=bM.replace(/<br\/>/g,"\n")}return bM};this.getStrBytes=function(bP){if(bP==null||bP===undefined){return 0}if(typeof bP!="string"){return 0}var bO=0,bM,bN,bL;for(bN=0,bL=bP.length;bN<bL;bN++){bM=bP.charCodeAt(bN);if(bM<=127){bO+=1}else{if(bM<=2047){bO+=2}else{if(bM<=65535){bO+=3}else{bO+=4}}}}return bO};this.xssFilter=function(bL){bL=bL.toString();bL=bL.replace(/[<]/g,"&lt;");bL=bL.replace(/[>]/g,"&gt;");bL=bL.replace(/"/g,"&quot;");return bL};this.trimStr=function(bL){if(!bL){return""}bL=bL.toString();return bL.replace(/(^\s*)|(\s*$)/g,"")};this.validNumber=function(bL){bL=bL.toString();return bL.match(/(^\d{1,8}$)/g)};this.getReturnError=function(bN,bM){if(!bM){bM=-100}var bL={ActionStatus:v.FAIL,ErrorCode:bM,ErrorInfo:bN+"["+bM+"]"};return bL};this.setCookie=function(bM,bO,bL,bP,bN){var bQ=new Date();bQ.setTime(bQ.getTime()+bL*1000);document.cookie=bM+"="+escape(bO)+";expires="+bQ.toGMTString()};this.getCookie=function(bM){var bL=document.cookie.match(new RegExp("(^| )"+bM+"=([^;]*)(;|$)"));if(bL!=null){return unescape(bL[2])}return null};this.delCookie=function(bL){var bN=new Date();bN.setTime(bN.getTime()-1);var bM=this.getCookie(bL);if(bM!=null){document.cookie=bL+"="+escape(bM)+";expires="+bN.toGMTString()}};this.getQueryString=function(bL){var bM=new RegExp("(^|&)"+bL+"=([^&]*)(&|$)","i");var bN=location.search.substr(1).match(bM);if(bN!=null){return unescape(bN[2])}return null}};var ba=new function(){var bL=true;this.setOn=function(bM){bL=bM};this.getOn=function(){return bL};this.error=function(bM){try{bL&&console.error(bM)}catch(bN){}};this.warn=function(bM){try{bL&&console.warn(bM)}catch(bN){}};this.info=function(bM){try{bL&&console.info(bM)}catch(bN){}};this.debug=function(bM){try{bL&&console.debug(bM)}catch(bN){}}};var aJ=function(bL){if(!bL){bL=new Date()}return Math.round(bL.getTime()/1000)};var aj=function(bL){return new Date(bL*1000)};var G=function(){if(az){az=az+1}else{az=Math.round(Math.random()*10000000)}return az};var bg=function(){return Math.round(Math.random()*4294967296)};var aa=function(bL,bM,bO,bQ,bP,bR,bN){wx.request({url:bM,data:bO,dataType:"json",method:bL,header:{"Content-Type":"application/json"},success:function(bS){aI=aB=0;if(bR){bR(bS.data)}},fail:function(bS){setTimeout(function(){var bU="请求服务器失败,请检查你的网络是否正常";var bT=af.getReturnError(bU,-2);if(bN){bN(bT)}},16)}})};var aM=function(bL,bM,bO,bQ,bP,bR,bN){aa(bL,bM,JSON.stringify(bO),bQ,bP,function(bT){var bS=null;if(bT){bS=JSON.parse(bT)}if(bR){bR(bS)}},bN)};var aZ=function(){return bw.sdkAppID&&bw.identifier};var bm=function(bN,bO){if(!aZ()){if(bO){var bM="请登录";var bL=af.getReturnError(bM,-4);if(bN){bN(bL)}}return false}return true};var s=function(){return w};var ar=function(bP,bO,bQ,bN){var bL=bE;if(s()){bL=bE.FORMAL.COMMON}else{bL=bE.TEST.COMMON}if(bP==bv.PIC){if(s()){bL=bE.FORMAL.PIC}else{bL=bE.TEST.PIC}}var bM=bL+"/"+O[bP]+"/"+bP+"/"+bO+"?websdkappid="+i.APPID+"&v="+i.VERSION;if(aZ()){if(bO=="login"){bM+="&identifier="+encodeURIComponent(bw.identifier)+"&usersig="+bw.userSig}else{if(bw.tinyid&&bw.a2){bM+="&tinyid="+bw.tinyid+"&a2="+bw.a2}else{if(bN){ba.error("tinyid或a2为空["+bP+"]["+bO+"]");bN(af.getReturnError("tinyid或a2为空["+bP+"]["+bO+"]",-5));return false}}}bM+="&contenttype="+bw.contentType}bM+="&sdkappid="+bw.sdkAppID+"&accounttype="+bw.accountType+"&apn="+bw.apn+"&reqtime="+aJ();return bM};var bJ=function(bL,bN){var bM=null;if(bj&&br[0]){bM="http://"+br[0]+"/asn.com/stddownload_common_file?authkey="+bj+"&bid="+bI.BUSSINESS_ID+"&subbid="+bw.sdkAppID+"&fileid="+bL+"&filetype="+J.SOUND+"&openid="+bN+"&ver=0"}else{ba.error("拼接语音下载url不报错：ip或者authkey为空")}return bM};var j=function(bM,bN,bO){var bL=null;if(bj&&br[0]){bL="http://"+br[0]+"/asn.com/stddownload_common_file?authkey="+bj+"&bid="+bI.BUSSINESS_ID+"&subbid="+bw.sdkAppID+"&fileid="+bM+"&filetype="+J.FILE+"&openid="+bN+"&ver=0&filename="+encodeURIComponent(bO)}else{ba.error("拼接文件下载url不报错：ip或者authkey为空")}bx.downloadMap["uuid_"+bM]=bL;return bL};var L=function(bO,bQ,bS,bM,bR,bP,bN){var bL={From_Account:bQ,To_Account:bR,os_platform:10,Timestamp:aJ().toString(),Random:bg().toString(),request_info:[{busi_id:bP,download_flag:bM,type:bN,uuid:bO,version:ac.SERVER_VERSION,auth_key:bj,ip:br[0]}]};U(bL,function(bT){if(bT.error_code==0&&bT.response_info){bx.downloadMap["uuid_"+bL.uuid]=bT.response_info.url}if(onAppliedDownloadUrl){onAppliedDownloadUrl({uuid:bL.uuid,url:bT.response_info.url,maps:bx.downloadMap})}},function(bT){ba.error("获取下载地址失败",bL.uuid)})};var H=function(){for(var bL in a6){var bM=a6[bL];if(bM){bM.abort();a6[ah]=null}}ah=0;a6={}};var u=function(){H();bw={sdkAppID:null,appIDAt3rd:null,accountType:null,identifier:null,identifierNick:null,userSig:null,contentType:"json",apn:1};C={};az=0;R=0;av=null;q=[];ax.clear();ak=null};var bl=function(bL,bO,bM,bP,bN){u();if(bM){C=bM}if(C.isAccessFormalEnv==false){ba.error("请切换为正式环境");w=C.isAccessFormalEnv}if(C.isLogOn==false){ba.setOn(C.isLogOn)}if(!bL){if(bN){bN(af.getReturnError("loginInfo is empty",-6));return}}if(!bL.sdkAppID){if(bN){bN(af.getReturnError("loginInfo.sdkAppID is empty",-7));return}}if(!bL.accountType){if(bN){bN(af.getReturnError("loginInfo.accountType is empty",-8));return}}if(bL.identifier){bw.identifier=bL.identifier.toString()}if(bL.identifier&&!bL.userSig){if(bN){bN(af.getReturnError("loginInfo.userSig is empty",-9));return}}if(bL.userSig){bw.userSig=bL.userSig.toString()}bw.sdkAppID=bL.sdkAppID;bw.accountType=bL.accountType;if(bw.identifier&&bw.userSig){ao(function(bQ,bR){ax.init(bO,function(bS){if(bP){bS.identifierNick=bQ;bS.headurl=bR;bP(bS)}},bN)},bN)}else{ax.init(bO,bP,bN)}};var aN=function(){a8="wechat"};var aO=function(bO,bT,bU){if(bO=="longpolling"&&(bT==ai||bT==f)){return}var bL=a4[bO];if(bL){var bM=aJ();var bR=null;var bP={Code:bT,ErrMsg:bU};if(bw.a2){bR=bw.a2.substring(0,10)+"_"+bM+"_"+bg()}else{if(bw.userSig){bR=bw.userSig.substring(0,10)+"_"+bM+"_"+bg()}}if(bR){var bQ={UniqKey:bR,EventId:bL,ReportTime:bM,MsgCmdErrorCode:bP};if(bO=="login"){var bS=[];bS.push(bQ);var bN={EvtItems:bS,MainVersion:i.VERSION,Version:"0"};aQ(bN,function(bW){bS=null},function(bW){bS=null})}else{q.push(bQ);if(q.length>=bA){var bV={EvtItems:q,MainVersion:i.VERSION,Version:"0"};aQ(bV,function(bW){q=[]},function(bW){q=[]})}}}}};var ao=function(bM,bL){aA.apiCall(bv.OPEN_IM,"login",{State:"Online"},function(bO){if(bO.TinyId){bw.tinyid=bO.TinyId}else{if(bL){bL(af.getReturnError("TinyId is empty",-10));return}}if(bO.A2Key){bw.a2=bO.A2Key}else{if(bL){bL(af.getReturnError("A2Key is empty",-11));return}}var bN=["Tag_Profile_IM_Nick","Tag_Profile_IM_Image"];var bP={From_Account:bw.identifier,To_Account:[bw.identifier],LastStandardSequence:0,TagList:bN};al(bP,function(bV){var bQ,bU,bS;if(bV.UserProfileItem&&bV.UserProfileItem.length>0){for(var bT in bV.UserProfileItem){for(var bR in bV.UserProfileItem[bT].ProfileItem){switch(bV.UserProfileItem[bT].ProfileItem[bR].Tag){case"Tag_Profile_IM_Nick":bQ=bV.UserProfileItem[bT].ProfileItem[bR].Value;if(bQ){bw.identifierNick=bQ}break;case"Tag_Profile_IM_Image":image=bV.UserProfileItem[bT].ProfileItem[bR].Value;if(image){bw.headurl=image}break}}}}if(bM){bM(bw.identifierNick,bw.headurl)}},bL)},bL)};var bu=function(bM,bN,bL){if(!bm(bL,false)){u();if(bN){bN({ActionStatus:v.OK,ErrorCode:0,ErrorInfo:"logout success"})}return}if(bM=="all"){aA.apiCall(bv.OPEN_IM,"logout",{},function(bO){u();if(bN){bN(bO)}},bL)}else{aA.apiCall(bv.OPEN_IM,"longpollinglogout",{LongPollingId:ak},function(bO){u();if(bN){bN(bO)}},bL)}};var aw=function(bL,bO,bM){if(!bm(bM,true)){return}var bV=null;switch(bL.sess.type()){case Y.C2C:bV={From_Account:bw.identifier,To_Account:bL.sess.id().toString(),MsgTimeStamp:bL.time,MsgSeq:bL.seq,MsgRandom:bL.random,MsgBody:[]};break;case Y.GROUP:var bU=bL.getSubType();bV={GroupId:bL.sess.id().toString(),From_Account:bw.identifier,Random:bL.random,MsgBody:[]};switch(bU){case aH.COMMON:bV.MsgPriority="COMMON";break;case aH.REDPACKET:bV.MsgPriority="REDPACKET";break;case aH.LOVEMSG:bV.MsgPriority="LOVEMSG";break;case aH.TIP:ba.error("不能主动发送群提示消息,subType="+bU);break;default:ba.error("发送群消息时，出现未知子消息类型：subType="+bU);return;break}break;default:break}for(var bR in bL.elems){var bN=bL.elems[bR];var bQ=null;var bS=bN.type;switch(bS){case aK.TEXT:bQ={Text:bN.content.text};break;case aK.FACE:bQ={Index:bN.content.index,Data:bN.content.data};break;case aK.IMAGE:var bT=[];for(var bP in bN.content.ImageInfoArray){bT.push({Type:bN.content.ImageInfoArray[bP].type,Size:bN.content.ImageInfoArray[bP].size,Width:bN.content.ImageInfoArray[bP].width,Height:bN.content.ImageInfoArray[bP].height,URL:bN.content.ImageInfoArray[bP].url})}bQ={UUID:bN.content.UUID,ImageInfoArray:bT};break;case aK.SOUND:ba.warn("web端暂不支持发送语音消息");continue;break;case aK.LOCATION:ba.warn("web端暂不支持发送地理位置消息");continue;break;case aK.FILE:bQ={UUID:bN.content.uuid,FileName:bN.content.name,FileSize:bN.content.size,DownloadFlag:bN.content.downFlag};break;case aK.CUSTOM:bQ={Data:bN.content.data,Desc:bN.content.desc,Ext:bN.content.ext};bS=aK.CUSTOM;break;default:ba.warn("web端暂不支持发送"+bN.type+"消息");continue;break}if(bL.PushInfoBoolean){bV.OfflinePushInfo=bL.PushInfo}bV.MsgBody.push({MsgType:bS,MsgContent:bQ})}if(bL.sess.type()==Y.C2C){aA.apiCall(bv.OPEN_IM,"sendmsg",bV,bO,bM)}else{if(bL.sess.type()==Y.GROUP){aA.apiCall(bv.GROUP,"send_group_msg",bV,bO,bM)}}};var B=function(bL,bN,bM){if(!w&&typeof stopPolling!="undefined"&&stopPolling==true){return}if(!bm(bM,true)){return}aA.apiCall(bv.OPEN_IM,"longpolling",bL,bN,bM,g,true)};var a0=function(bL,bO,bM,bN){aA.apiCall(bv.BIG_GROUP_LONG_POLLING,"get_msg",bL,bO,bM,bN)};var aX=function(bM,bL,bO,bN){if(!bm(bN,true)){return}aA.apiCall(bv.OPEN_IM,"getmsg",{Cookie:bM,SyncFlag:bL},function(bQ){if(bQ.MsgList&&bQ.MsgList.length){for(var bP in bQ.MsgList){bt.push(bQ.MsgList[bP])}}if(bQ.SyncFlag==1){aX(bQ.Cookie,bQ.SyncFlag,bO,bN)}else{bQ.MsgList=bt;bt=[];if(bO){bO(bQ)}}},bN)};var by=function(bN,bQ,bR,bO){if(!bm(bO,true)){return}var bL=[];for(var bM in bQ){var bP={To_Account:bQ[bM].toAccount,LastedMsgTime:bQ[bM].lastedMsgTime};bL.push(bP)}aA.apiCall(bv.OPEN_IM,"msgreaded",{C2CMsgReaded:{Cookie:bN,C2CMsgReadedItem:bL}},bR,bO)};var bK=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.OPEN_IM,"deletemsg",bL,bN,bM)};var W=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.OPEN_IM,"getroammsg",bL,function(bS){var bR=bL.MaxCnt;var bO=bS.Complete;var bV=bS.MaxCnt;var bU=bS.MsgKey;var bT=bS.LastMsgTime;if(bS.MsgList&&bS.MsgList.length){for(var bP in bS.MsgList){bG.push(bS.MsgList[bP])}}var bQ=null;if(bO==0){if(bV<bR){bQ={Peer_Account:bL.Peer_Account,MaxCnt:bR-bV,LastMsgTime:bT,MsgKey:bU}}}if(bQ){W(bQ,bN,bM)}else{bS.MsgList=bG;bG=[];if(bN){bN(bS)}}},bM)};var aW=function(bL,bQ,bO){if(!bm(bO,true)){return}var bN={Type:bL.Type,Name:bL.Name};var bP=[];for(var bM=0;bM<bL.MemberList.length;bM++){bP.push({Member_Account:bL.MemberList[bM]})}bN.MemberList=bP;if(bL.GroupId){bN.GroupId=bL.GroupId}if(bL.Owner_Account){bN.Owner_Account=bL.Owner_Account}if(bL.Introduction){bN.Introduction=bL.Introduction}if(bL.Notification){bN.Notification=bL.Notification}if(bL.MaxMemberCount){bN.MaxMemberCount=bL.MaxMemberCount}if(bL.ApplyJoinOption){bN.ApplyJoinOption=bL.ApplyJoinOption}if(bL.AppDefinedData){bN.AppDefinedData=bL.AppDefinedData}if(bL.FaceUrl){bN.FaceUrl=bL.FaceUrl}aA.apiCall(bv.GROUP,"create_group",bN,bQ,bO)};var ay=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.GROUP,"create_group",bL,bN,bM)};var bh=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.GROUP,"modify_group_base_info",bL,bN,bM)};var aC=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.GROUP,"apply_join_group",{GroupId:bL.GroupId,ApplyMsg:bL.ApplyMsg,UserDefinedField:bL.UserDefinedField},bN,bM)};var be=function(bL,bO,bM){var bN;if(!bm(bM,false)){bN=bv.BIG_GROUP}else{bN=bv.GROUP}aA.apiCall(bN,"apply_join_group",{GroupId:bL.GroupId,ApplyMsg:bL.ApplyMsg,UserDefinedField:bL.UserDefinedField},function(bP){if(bP.JoinedStatus&&bP.JoinedStatus=="JoinedSuccess"){if(bP.LongPollingKey){ax.setBigGroupLongPollingOn(true);ax.setBigGroupLongPollingKey(bP.LongPollingKey);ax.setBigGroupLongPollingMsgMap(bL.GroupId,0);ax.bigGroupLongPolling()}else{bM&&bM(af.getReturnError("The type of group is not AVChatRoom: groupid="+bL.GroupId,-12));return}}if(bO){bO(bP)}},function(bP){if(bM){bM(bP)}})};var o=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.GROUP,"handle_apply_join_group",{GroupId:bL.GroupId,Applicant_Account:bL.Applicant_Account,HandleMsg:bL.HandleMsg,Authentication:bL.Authentication,MsgKey:bL.MsgKey,ApprovalMsg:bL.ApprovalMsg,UserDefinedField:bL.UserDefinedField},bN,function(bO){if(bO.ErrorCode==10024){if(bN){var bP={ActionStatus:v.OK,ErrorCode:0,ErrorInfo:"该申请已经被处理过"};bN(bP)}}else{if(bM){bM(bO)}}})};var aD=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.GROUP,"quit_group",{GroupId:bL.GroupId},bN,bM)};var bB=function(bL,bO,bM){var bN;if(!bm(bM,false)){bN=bv.BIG_GROUP}else{bN=bv.GROUP}aA.apiCall(bN,"quit_group",{GroupId:bL.GroupId},function(bP){ax.resetBigGroupLongPollingInfo();if(bO){bO(bP)}},bM)};var M=function(bL,bN,bM){aA.apiCall(bv.GROUP,"search_group",bL,bN,bM)};var e=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.GROUP,"get_group_public_info",{GroupIdList:bL.GroupIdList,ResponseFilter:{GroupBasePublicInfoFilter:bL.GroupBasePublicInfoFilter}},function(bQ){bQ.ErrorInfo="";if(bQ.GroupInfo){for(var bO in bQ.GroupInfo){var bP=bQ.GroupInfo[bO].ErrorCode;if(bP>0){bQ.ActionStatus=v.FAIL;bQ.GroupInfo[bO].ErrorInfo="["+bP+"]"+bQ.GroupInfo[bO].ErrorInfo;bQ.ErrorInfo+=bQ.GroupInfo[bO].ErrorInfo+"\n"}}}if(bQ.ActionStatus==v.FAIL){if(bM){bM(bQ)}}else{if(bN){bN(bQ)}}},bM)};var V=function(bL,bO,bN){if(!bm(bN,true)){return}var bM={GroupIdList:bL.GroupIdList,ResponseFilter:{GroupBaseInfoFilter:bL.GroupBaseInfoFilter,MemberInfoFilter:bL.MemberInfoFilter}};if(bL.AppDefinedDataFilter_Group){bM.ResponseFilter.AppDefinedDataFilter_Group=bL.AppDefinedDataFilter_Group}if(bL.AppDefinedDataFilter_GroupMember){bM.ResponseFilter.AppDefinedDataFilter_GroupMember=bL.AppDefinedDataFilter_GroupMember}aA.apiCall(bv.GROUP,"get_group_info",bM,bO,bN)};var bi=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.GROUP,"get_group_member_info",{GroupId:bL.GroupId,Offset:bL.Offset,Limit:bL.Limit,MemberInfoFilter:bL.MemberInfoFilter,MemberRoleFilter:bL.MemberRoleFilter,AppDefinedDataFilter_GroupMember:bL.AppDefinedDataFilter_GroupMember},bN,bM)};var t=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.GROUP,"add_group_member",{GroupId:bL.GroupId,Silence:bL.Silence,MemberList:bL.MemberList},bN,bM)};var m=function(bL,bO,bN){if(!bm(bN,true)){return}var bM={};if(bL.GroupId){bM.GroupId=bL.GroupId}if(bL.Member_Account){bM.Member_Account=bL.Member_Account}if(bL.Role){bM.Role=bL.Role}if(bL.MsgFlag){bM.MsgFlag=bL.MsgFlag}if(bL.ShutUpTime){bM.ShutUpTime=bL.ShutUpTime}if(bL.NameCard){bM.NameCard=bL.NameCard}if(bL.AppMemberDefinedData){bM.AppMemberDefinedData=bL.AppMemberDefinedData}aA.apiCall(bv.GROUP,"modify_group_member_info",bM,bO,bN)};var aT=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.GROUP,"delete_group_member",{GroupId:bL.GroupId,Silence:bL.Silence,MemberToDel_Account:bL.MemberToDel_Account,Reason:bL.Reason},bN,bM)};var an=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.GROUP,"destroy_group",{GroupId:bL.GroupId},bN,bM)};var c=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.GROUP,"change_group_owner",bL,bN,bM)};var bd=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.GROUP,"get_joined_group_list",{Member_Account:bL.Member_Account,Limit:bL.Limit,Offset:bL.Offset,GroupType:bL.GroupType,ResponseFilter:{GroupBaseInfoFilter:bL.GroupBaseInfoFilter,SelfInfoFilter:bL.SelfInfoFilter}},bN,bM)};var D=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.GROUP,"get_role_in_group",{GroupId:bL.GroupId,User_Account:bL.User_Account},bN,bM)};var y=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.GROUP,"forbid_send_msg",{GroupId:bL.GroupId,Members_Account:bL.Members_Account,ShutUpTime:bL.ShutUpTime},bN,bM)};var F=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.GROUP,"send_group_system_notification",bL,bN,bM)};var aE=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.GROUP,"group_msg_get",{GroupId:bL.GroupId,ReqMsgSeq:bL.ReqMsgSeq,ReqMsgNumber:bL.ReqMsgNumber},bN,bM)};var bz=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.GROUP,"msg_read_report",{GroupId:bL.GroupId,MsgReadedSeq:bL.MsgReadedSeq},bN,bM)};var ab=function(bR){var bP=[];if(bR.Fail_Account&&bR.Fail_Account.length){bP=bR.Fail_Account}if(bR.Invalid_Account&&bR.Invalid_Account.length){for(var bM in bR.Invalid_Account){bP.push(bR.Invalid_Account[bM])}}if(bP.length){bR.ActionStatus=v.FAIL;bR.ErrorCode=k;bR.ErrorInfo="";for(var bO in bP){var bQ=bP[bO];for(var bN in bR.ResultItem){if(bR.ResultItem[bN].To_Account==bQ){var bL=bR.ResultItem[bN].ResultCode;bR.ResultItem[bN].ResultInfo="["+bL+"]"+bR.ResultItem[bN].ResultInfo;bR.ErrorInfo+=bR.ResultItem[bN].ResultInfo+"\n";break}}}}return bR};var aY=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.FRIEND,"friend_add",{From_Account:bw.identifier,AddFriendItem:bL.AddFriendItem},function(bP){var bO=ab(bP);if(bO.ActionStatus==v.FAIL){if(bM){bM(bO)}}else{if(bN){bN(bO)}}},bM)};var I=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.FRIEND,"friend_delete",{From_Account:bw.identifier,To_Account:bL.To_Account,DeleteType:bL.DeleteType},function(bP){var bO=ab(bP);if(bO.ActionStatus==v.FAIL){if(bM){bM(bO)}}else{if(bN){bN(bO)}}},bM)};var r=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.FRIEND,"pendency_get",{From_Account:bw.identifier,PendencyType:bL.PendencyType,StartTime:bL.StartTime,MaxLimited:bL.MaxLimited,LastSequence:bL.LastSequence},bN,bM)};var ag=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.FRIEND,"pendency_delete",{From_Account:bw.identifier,PendencyType:bL.PendencyType,To_Account:bL.To_Account},function(bP){var bO=ab(bP);if(bO.ActionStatus==v.FAIL){if(bM){bM(bO)}}else{if(bN){bN(bO)}}},bM)};var Z=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.FRIEND,"friend_response",{From_Account:bw.identifier,ResponseFriendItem:bL.ResponseFriendItem},function(bP){var bO=ab(bP);if(bO.ActionStatus==v.FAIL){if(bM){bM(bO)}}else{if(bN){bN(bO)}}},bM)};var bp=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.FRIEND,"friend_get_all",{From_Account:bw.identifier,TimeStamp:bL.TimeStamp,StartIndex:bL.StartIndex,GetCount:bL.GetCount,LastStandardSequence:bL.LastStandardSequence,TagList:bL.TagList},bN,bM)};var al=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.PROFILE,"portrait_get",{From_Account:bw.identifier,To_Account:bL.To_Account,TagList:bL.TagList},function(bU){var bS=[];if(bU.Fail_Account&&bU.Fail_Account.length){bS=bU.Fail_Account}if(bU.Invalid_Account&&bU.Invalid_Account.length){for(var bP in bU.Invalid_Account){bS.push(bU.Invalid_Account[bP])}}if(bS.length){bU.ActionStatus=v.FAIL;bU.ErrorCode=k;bU.ErrorInfo="";for(var bR in bS){var bT=bS[bR];for(var bQ in bU.UserProfileItem){if(bU.UserProfileItem[bQ].To_Account==bT){var bO=bU.UserProfileItem[bQ].ResultCode;bU.UserProfileItem[bQ].ResultInfo="["+bO+"]"+bU.UserProfileItem[bQ].ResultInfo;bU.ErrorInfo+="账号:"+bT+","+bU.UserProfileItem[bQ].ResultInfo+"\n";break}}}}if(bU.ActionStatus==v.FAIL){if(bM){bM(bU)}}else{if(bN){bN(bU)}}},bM)};var bb=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.PROFILE,"portrait_set",{From_Account:bw.identifier,ProfileItem:bL.ProfileItem},function(bQ){for(var bO in bL.ProfileItem){var bP=bL.ProfileItem[bO];if(bP.Tag=="Tag_Profile_IM_Nick"){bw.identifierNick=bP.Value;break}}if(bN){bN(bQ)}},bM)};var l=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.FRIEND,"black_list_add",{From_Account:bw.identifier,To_Account:bL.To_Account},function(bP){var bO=ab(bP);if(bO.ActionStatus==v.FAIL){if(bM){bM(bO)}}else{if(bN){bN(bO)}}},bM)};var am=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.FRIEND,"black_list_delete",{From_Account:bw.identifier,To_Account:bL.To_Account},function(bP){var bO=ab(bP);if(bO.ActionStatus==v.FAIL){if(bM){bM(bO)}}else{if(bN){bN(bO)}}},bM)};var x=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.FRIEND,"black_list_get",{From_Account:bw.identifier,StartIndex:bL.StartIndex,MaxLimited:bL.MaxLimited,LastSequence:bL.LastSequence},bN,bM)};var aF=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.RECENT_CONTACT,"get",{From_Account:bw.identifier,Count:bL.Count},bN,bM)};var ae=function(bM,bO,bN){if(!bm(bN,true)){return}var bL;if(s()){bL="pic_up"}else{bL="pic_up_test"}aA.apiCall(bv.PIC,bL,{App_Version:ac.APP_VERSION,From_Account:bw.identifier,To_Account:bM.To_Account,Seq:bM.Seq,Timestamp:bM.Timestamp,Random:bM.Random,File_Str_Md5:bM.File_Str_Md5,File_Size:bM.File_Size,File_Type:bM.File_Type,Server_Ver:ac.SERVER_VERSION,Auth_Key:bj,Busi_Id:bM.Busi_Id,PkgFlag:bM.PkgFlag,Slice_Offset:bM.Slice_Offset,Slice_Size:bM.Slice_Size,Slice_Data:bM.Slice_Data},bO,bN)};var bf=function(bM,bL){if(!bm(bL,true)){return}aA.apiCall(bv.OPEN_IM,"authkey",{},bM,bL)};var aQ=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.IM_OPEN_STAT,"web_report",bL,bN,bM)};var T=function(bL,bN,bM){if(!bm(bM,true)){return}aA.apiCall(bv.OPEN_IM,"getlongpollingid",{},function(bO){bN&&bN(bO)},bM)};var U=function(bL,bN,bM){aA.apiCall(bv.PIC,"apply_download",bL,bN,bM)};aN();var aA=bs==false?new function(){var bL=null;this.init=function(bN,bO,bM){if(bN){bL=bN}};this.callBack=function(bM){if(bL){bL(bM)}};this.clear=function(){bL=null};this.apiCall=function(bO,bS,bR,bT,bN,bQ,bP){var bM=ar(bO,bS,bT,bN);if(bM==false){return}aM("POST",bM,bR,bQ,bP,function(bX){var bV=null,bW="";if(bS=="pic_up"){bR.Slice_Data=""}var bU="\n request url: \n"+bM+"\n request body: \n"+JSON.stringify(bR)+"\n response: \n"+JSON.stringify(bX);if(bX.ActionStatus==v.OK){ba.info("["+bO+"]["+bS+"]success: "+bU);if(bT){bT(bX)}bV=0;bW=""}else{bV=bX.ErrorCode;bW=bX.ErrorInfo;if(bN){bX.SrcErrorInfo=bX.ErrorInfo;bX.ErrorInfo="["+bO+"]["+bS+"]failed: "+bU;if(bS!="longpolling"||bX.ErrorCode!=ai){ba.error(bX.ErrorInfo)}bN(bX)}}aO(bS,bV,bW)},function(bU){bN&&bN(bU);aO(bS,bU.ErrorCode,bU.ErrorInfo)})}}:new function(){var bL=null;this.init=function(bN,bO,bM){if(bN){bL=bN}};this.callBack=function(bM){if(bL){bL(bM)}};this.clear=function(){bL=null};this.apiCall=function(bW,bQ,bT,bR,bP,bY,bN){var bO=ar(bW,bQ,bR,bP);if(bO==false){return}var bU=R++,bV="jsonpcallback",bM="jsonpRequest"+bU,bX=document.createElement("script"),bS=0;window[bM]=a7;bX.type="text/javascript";bO=bO+"&"+bV+"="+bM+"&jsonpbody="+encodeURIComponent(JSON.stringify(bT));bX.src=bO;bX.async=true;if(typeof bX.onreadystatechange!=="undefined"){bX.event="onclick";bX.htmlFor=bX.id="_jsonpRequest_"+bU}bX.onload=bX.onreadystatechange=function(){if((this.readyState&&this.readyState!=="complete"&&this.readyState!=="loaded")||bS){return false}bX.onload=bX.onreadystatechange=null;bX.onclick&&bX.onclick();var b0=av;var bZ="\n request url: \n"+bO+"\n request body: \n"+JSON.stringify(bT)+"\n response: \n"+JSON.stringify(b0);if(b0.ActionStatus==v.OK){ba.info("["+bW+"]["+bQ+"]success: "+bZ);bR&&bR(b0)}else{b0.ErrorInfo="["+bW+"]["+bQ+"]failed "+bZ;if(bQ!="longpolling"||b0.ErrorCode!=ai){ba.error(b0.ErrorInfo)}else{ba.warn("["+bW+"]["+bQ+"]success: "+bZ)}bP&&bP(b0)}av=undefined;document.body.removeChild(bX);bS=1};document.body.appendChild(bX)}};var bC=function(bO,bQ,bM,bN,bP,bL){this._impl={skey:bC.skey(bO,bQ),type:bO,id:bQ,name:bM,icon:bN,unread:0,isAutoRead:false,time:bP>=0?bP:0,curMaxMsgSeq:bL>=0?bL:0,msgs:[],isFinished:1}};bC.skey=function(bL,bM){return bL+bM};bC.prototype.type=function(){return this._impl.type};bC.prototype.id=function(){return this._impl.id};bC.prototype.name=function(){return this._impl.name};bC.prototype.icon=function(){return this._impl.icon};bC.prototype.unread=function(bL){if(typeof bL!=="undefined"){this._impl.unread=bL}else{return this._impl.unread}};bC.prototype.isFinished=function(bL){if(typeof bL!=="undefined"){this._impl.isFinished=bL}else{return this._impl.isFinished}};bC.prototype.time=function(){return this._impl.time};bC.prototype.curMaxMsgSeq=function(bL){if(typeof bL!=="undefined"){this._impl.curMaxMsgSeq=bL}else{return this._impl.curMaxMsgSeq}};bC.prototype.msgCount=function(){return this._impl.msgs.length};bC.prototype.msg=function(bL){return this._impl.msgs[bL]};bC.prototype.msgs=function(){return this._impl.msgs};bC.prototype._impl_addMsg=function(bL){this._impl.msgs.push(bL);if(bL.time>this._impl.time){this._impl.time=bL.time}if(bL.seq>this._impl.curMaxMsgSeq){this._impl.curMaxMsgSeq=bL.seq}if(!bL.isSend&&!this._impl.isAutoRead){this._impl.unread++}};var aq=function(bM,bL){this.toAccount=bM;this.lastedMsgTime=bL};var S=function(bN,bS,bM,bO,bP,bL,bR,bQ){this.sess=bN;this.subType=bR>=0?bR:0;this.fromAccount=bL;this.fromAccountNick=bQ?bQ:bL;this.isSend=Boolean(bS);this.seq=bM>=0?bM:G();this.random=bO>=0?bO:bg();this.time=bP>=0?bP:aJ();this.elems=[]};S.prototype.getSession=function(){return this.sess};S.prototype.getType=function(){return this.subType};S.prototype.getSubType=function(){return this.subType};S.prototype.getFromAccount=function(){return this.fromAccount};S.prototype.getFromAccountNick=function(){return this.fromAccountNick};S.prototype.getIsSend=function(){return this.isSend};S.prototype.getSeq=function(){return this.seq};S.prototype.getTime=function(){return this.time};S.prototype.getRandom=function(){return this.random};S.prototype.getElems=function(){return this.elems};S.prototype.addText=function(bL){this.addElem(new aV.Msg.Elem(aK.TEXT,bL))};S.prototype.addFace=function(bL){this.addElem(new aV.Msg.Elem(aK.FACE,bL))};S.prototype.addImage=function(bL){this.addElem(new aV.Msg.Elem(aK.IMAGE,bL))};S.prototype.addLocation=function(bL){this.addElem(new aV.Msg.Elem(aK.LOCATION,bL))};S.prototype.addFile=function(bL){this.addElem(new aV.Msg.Elem(aK.FILE,bL))};S.prototype.addCustom=function(bL){this.addElem(new aV.Msg.Elem(aK.CUSTOM,bL))};S.prototype.addElem=function(bL){this.elems.push(bL)};S.prototype.toHtml=function(){var bM="";for(var bL in this.elems){var bN=this.elems[bL];bM+=bN.toHtml()}return bM};S.Elem=function(bL,bM){this.type=bL;this.content=bM};S.Elem.prototype.getType=function(){return this.type};S.Elem.prototype.getContent=function(){return this.content};S.Elem.prototype.toHtml=function(){var bL;bL=this.content.toHtml();return bL};S.Elem.Text=function(bL){this.text=af.xssFilter(bL)};S.Elem.Text.prototype.getText=function(){return this.text};S.Elem.Text.prototype.toHtml=function(){return this.text};S.Elem.Face=function(bL,bM){this.index=bL;this.data=bM};S.Elem.Face.prototype.getIndex=function(){return this.index};S.Elem.Face.prototype.getData=function(){return this.data};S.Elem.Face.prototype.toHtml=function(){var bN=null;var bM=bo[this.data];var bL=bn[bM];if(bL&&bL[1]){bN=bL[1]}if(bN){return"<img src='"+bN+"'/>"}else{return this.data}};S.Elem.Location=function(bL,bN,bM){this.latitude=bN;this.longitude=bL;this.desc=bM};S.Elem.Location.prototype.getLatitude=function(){return this.latitude};S.Elem.Location.prototype.getLongitude=function(){return this.longitude};S.Elem.Location.prototype.getDesc=function(){return this.desc};S.Elem.Location.prototype.toHtml=function(){return"经度="+this.longitude+",纬度="+this.latitude+",描述="+this.desc};S.Elem.Images=function(bL){this.UUID=bL;this.ImageInfoArray=[]};S.Elem.Images.prototype.addImage=function(bL){this.ImageInfoArray.push(bL)};S.Elem.Images.prototype.toHtml=function(){var bN=this.getImage(aG.SMALL);var bM=this.getImage(aG.LARGE);var bL=this.getImage(aG.ORIGIN);if(!bM){bM=bN}if(!bL){bL=bN}return"<img src='"+bN.getUrl()+"#"+bM.getUrl()+"#"+bL.getUrl()+"' style='CURSOR: hand' id='"+this.getImageId()+"' bigImgUrl='"+bM.getUrl()+"' onclick='imageClick(this)' />"};S.Elem.Images.prototype.getImageId=function(){return this.UUID};S.Elem.Images.prototype.getImage=function(bM){for(var bL in this.ImageInfoArray){if(this.ImageInfoArray[bL].getType()==bM){return this.ImageInfoArray[bL]}}return null};S.Elem.Images.Image=function(bP,bN,bO,bL,bM){this.type=bP;this.size=bN;this.width=bO;this.height=bL;this.url=bM};S.Elem.Images.Image.prototype.getType=function(){return this.type};S.Elem.Images.Image.prototype.getSize=function(){return this.size};S.Elem.Images.Image.prototype.getWidth=function(){return this.width};S.Elem.Images.Image.prototype.getHeight=function(){return this.height};S.Elem.Images.Image.prototype.getUrl=function(){return this.url};S.Elem.Sound=function(bP,bN,bO,bQ,bR,bM,bL){this.uuid=bP;this.second=bN;this.size=bO;this.senderId=bQ;this.receiverId=bR;this.downFlag=bM;this.busiId=bL==Y.C2C?2:1;if(bM!==undefined&&busiId!==undefined){L(bP,bQ,bN,bM,bR,this.busiId,P.SOUND)}else{this.downUrl=bJ(bP,bQ,bN)}};S.Elem.Sound.prototype.getUUID=function(){return this.uuid};S.Elem.Sound.prototype.getSecond=function(){return this.second};S.Elem.Sound.prototype.getSize=function(){return this.size};S.Elem.Sound.prototype.getSenderId=function(){return this.senderId};S.Elem.Sound.prototype.getDownUrl=function(){return this.downUrl};S.Elem.Sound.prototype.toHtml=function(){if(a8.type=="ie"&&parseInt(a8.ver)<=8){return"[这是一条语音消息]demo暂不支持ie8(含)以下浏览器播放语音,语音URL:"+this.downUrl}return'<audio id="uuid_'+this.uuid+'" src="'+this.downUrl+'" controls="controls" onplay="onChangePlayAudio(this)" preload="none"></audio>'};S.Elem.File=function(bP,bN,bO,bQ,bR,bM,bL){this.uuid=bP;this.name=bN;this.size=bO;this.senderId=bQ;this.receiverId=bR;this.downFlag=bM;this.busiId=bL==Y.C2C?2:1;if(bM!==undefined&&busiId!==undefined){L(bP,bQ,bN,bM,bR,this.busiId,P.FILE)}else{this.downUrl=j(bP,bQ,bN)}};S.Elem.File.prototype.getUUID=function(){return this.uuid};S.Elem.File.prototype.getName=function(){return this.name};S.Elem.File.prototype.getSize=function(){return this.size};S.Elem.File.prototype.getSenderId=function(){return this.senderId};S.Elem.File.prototype.getDownUrl=function(){return this.downUrl};S.Elem.File.prototype.getDownFlag=function(){return this.downFlag};S.Elem.File.prototype.toHtml=function(){var bL,bM;bL=this.size;bM="Byte";if(this.size>=1024){bL=Math.round(this.size/1024);bM="KB"}return'<a href="javascript" onclick="webim.onDownFile("'+this.uuid+'")" title="点击下载文件" ><i class="glyphicon glyphicon-file">&nbsp;'+this.name+"("+bL+bM+")</i></a>"};S.Elem.GroupTip=function(bN,bL,bM,bP,bO){this.opType=bN;this.opUserId=bL;this.groupId=bM;this.groupName=bP;this.userIdList=bO?bO:[];this.groupInfoList=[];this.memberInfoList=[];this.groupMemberNum=null};S.Elem.GroupTip.prototype.addGroupInfo=function(bL){this.groupInfoList.push(bL)};S.Elem.GroupTip.prototype.addMemberInfo=function(bL){this.memberInfoList.push(bL)};S.Elem.GroupTip.prototype.getOpType=function(){return this.opType};S.Elem.GroupTip.prototype.getOpUserId=function(){return this.opUserId};S.Elem.GroupTip.prototype.getGroupId=function(){return this.groupId};S.Elem.GroupTip.prototype.getGroupName=function(){return this.groupName};S.Elem.GroupTip.prototype.getUserIdList=function(){return this.userIdList};S.Elem.GroupTip.prototype.getGroupInfoList=function(){return this.groupInfoList};S.Elem.GroupTip.prototype.getMemberInfoList=function(){return this.memberInfoList};S.Elem.GroupTip.prototype.getGroupMemberNum=function(){return this.groupMemberNum};S.Elem.GroupTip.prototype.setGroupMemberNum=function(bL){return this.groupMemberNum=bL};S.Elem.GroupTip.prototype.toHtml=function(){var bR="[群提示消息]";var bO=N-1;switch(this.opType){case h.JOIN:bR+=this.opUserId+"邀请了";for(var bM in this.userIdList){bR+=this.userIdList[bM]+",";if(this.userIdList.length>N&&bM==bO){bR+="等"+this.userIdList.length+"人";break}}bR+="加入该群";break;case h.QUIT:bR+=this.opUserId+"主动退出该群";break;case h.KICK:bR+=this.opUserId+"将";for(var bM in this.userIdList){bR+=this.userIdList[bM]+",";if(this.userIdList.length>N&&bM==bO){bR+="等"+this.userIdList.length+"人";break}}bR+="踢出该群";break;case h.SET_ADMIN:bR+=this.opUserId+"将";for(var bM in this.userIdList){bR+=this.userIdList[bM]+",";if(this.userIdList.length>N&&bM==bO){bR+="等"+this.userIdList.length+"人";break}}bR+="设为管理员";break;case h.CANCEL_ADMIN:bR+=this.opUserId+"取消";for(var bM in this.userIdList){bR+=this.userIdList[bM]+",";if(this.userIdList.length>N&&bM==bO){bR+="等"+this.userIdList.length+"人";break}}bR+="的管理员资格";break;case h.MODIFY_GROUP_INFO:bR+=this.opUserId+"修改了群资料：";for(var bM in this.groupInfoList){var bP=this.groupInfoList[bM].getType();var bQ=this.groupInfoList[bM].getValue();switch(bP){case aU.FACE_URL:bR+="群头像为"+bQ+"; ";break;case aU.NAME:bR+="群名称为"+bQ+"; ";break;case aU.OWNER:bR+="群主为"+bQ+"; ";break;case aU.NOTIFICATION:bR+="群公告为"+bQ+"; ";break;case aU.INTRODUCTION:bR+="群简介为"+bQ+"; ";break;default:bR+="未知信息为:type="+bP+",value="+bQ+"; ";break}}break;case h.MODIFY_MEMBER_INFO:bR+=this.opUserId+"修改了群成员资料:";for(var bM in this.memberInfoList){var bN=this.memberInfoList[bM].getUserId();var bL=this.memberInfoList[bM].getShutupTime();bR+=bN+": ";if(bL!=null&&bL!==undefined){if(bL==0){bR+="取消禁言; "}else{bR+="禁言"+bL+"秒; "}}else{bR+=" shutupTime为空"}if(this.memberInfoList.length>N&&bM==bO){bR+="等"+this.memberInfoList.length+"人";break}}break;case h.READED:Log.info("消息已读同步");break;default:bR+="未知群提示消息类型：type="+this.opType;break}return bR};S.Elem.GroupTip.GroupInfo=function(bL,bM){this.type=bL;this.value=bM};S.Elem.GroupTip.GroupInfo.prototype.getType=function(){return this.type};S.Elem.GroupTip.GroupInfo.prototype.getValue=function(){return this.value};S.Elem.GroupTip.MemberInfo=function(bM,bL){this.userId=bM;this.shutupTime=bL};S.Elem.GroupTip.MemberInfo.prototype.getUserId=function(){return this.userId};S.Elem.GroupTip.MemberInfo.prototype.getShutupTime=function(){return this.shutupTime};S.Elem.Custom=function(bM,bN,bL){this.data=bM;this.desc=bN;this.ext=bL};S.Elem.Custom.prototype.getData=function(){return this.data};S.Elem.Custom.prototype.getDesc=function(){return this.desc};S.Elem.Custom.prototype.getExt=function(){return this.ext};S.Elem.Custom.prototype.toHtml=function(){return this.data};var bk=new function(){var bM={};var bO=[];a={};this.cookie="";this.syncFlag=0;var bN=function(bQ){for(var bP in bM){bQ(bM[bP])}};var bL=function(bS){var bR=false;var bT=bS.sess._impl.skey;var bQ=bS.isSend+bS.seq+bS.random;var bP=a[bT]&&a[bT][bQ];if(bP){bR=true}if(a[bT]){a[bT][bQ]={time:bS.time}}else{a[bT]={};a[bT][bQ]={time:bS.time}}return bR};this.sessMap=function(){return bM};this.sessCount=function(){return bO.length};this.sessByTypeId=function(bQ,bR){var bP=bC.skey(bQ,bR);if(bP===undefined||bP==null){return null}return bM[bP]};this.delSessByTypeId=function(bQ,bR){var bP=bC.skey(bQ,bR);if(bP===undefined||bP==null){return false}if(bM[bP]){delete bM[bP];delete a[bP]}return true};this.resetCookieAndSyncFlag=function(){this.cookie="";this.syncFlag=0};this.setAutoRead=function(bR,bT,bP){if(bP){bN(function(bU){bU._impl.isAutoRead=false})}if(bR){bR._impl.isAutoRead=bT;if(bT){bR._impl.unread=0;if(bR._impl.type==Y.C2C){var bQ=[];bQ.push(new aq(bR._impl.id,bR._impl.time));by(bk.cookie,bQ,function(bU){ba.info("[setAutoRead]: c2CMsgReaded success")},function(bU){ba.error("[setAutoRead}: c2CMsgReaded failed:"+bU.ErrorInfo)})}else{if(bR._impl.type==Y.GROUP){var bS={GroupId:bR._impl.id,MsgReadedSeq:bR._impl.curMaxMsgSeq};bz(bS,function(bU){ba.info("groupMsgReaded success")},function(bU){ba.error("groupMsgReaded failed:"+bU.ErrorInfo)})}}}}};this.c2CMsgReaded=function(bR,bS,bQ){var bP=[];bP.push(new aq(bR.To_Account,bR.LastedMsgTime));by(bk.cookie,bP,function(bT){if(bS){ba.info("c2CMsgReaded success");bS(bT)}},function(bT){if(bQ){ba.error("c2CMsgReaded failed:"+bT.ErrorInfo);bQ(bT)}})};this.addSession=function(bP){bM[bP._impl.skey]=bP};this.delSession=function(bP){delete bM[bP._impl.skey]};this.addMsg=function(bQ){if(bL(bQ)){return false}var bP=bQ.sess;if(!bM[bP._impl.skey]){this.addSession(bP)}bP._impl_addMsg(bQ);return true};this.updateTimeline=function(){var bP=new Array;bN(function(bQ){bP.push(bQ)});bP.sort(function(bR,bQ){return bQ.time-bR.time});bO=bP}};var ax=new function(){var ce=null;var bU=null;var b6={"1":null,"2":null,"3":null,"4":null,"5":null,"6":null,"7":null,"8":null,"9":null,"10":null,"11":null,"15":null,"255":null};var bM={"1":null,"2":null,"3":null,"4":null,"5":null,"6":null,"7":null,"8":null};var b3={"1":null};var b1=null;var cd=null;var bZ=false;var bR=false;var bL=0;var cc=0;var bN=null;var b5=false;var bV=0;var cf=90;var ca=null;var bQ={};var ck=0;var ci={};var bT={};this.setLongPollingOn=function(cn){bZ=cn};this.getLongPollingOn=function(){return bZ};this.resetLongPollingInfo=function(){bZ=false;bL=0;cc=0};this.setBigGroupLongPollingOn=function(cn){b5=cn};this.setBigGroupLongPollingKey=function(cn){ca=cn};this.resetBigGroupLongPollingInfo=function(){b5=false;bV=0;ca=null;bQ={}};this.setBigGroupLongPollingMsgMap=function(cn,co){var cp=bQ[cn];if(cp){cp=parseInt(cp)+co;bQ[cn]=cp}else{bQ[cn]=co}};this.clear=function(){bU=null;b6={"1":null,"2":null,"3":null,"4":null,"5":null,"6":null,"7":null,"8":null,"9":null,"10":null,"11":null,"15":null,"255":null};bM={"1":null,"2":null,"3":null,"4":null,"5":null,"6":null,"7":null,"8":null};b3={"1":null};ce=null;bZ=false;bL=0;cc=0;bN=null;b5=false;bV=0;ca=null;bQ={};bT={};br=[];bj=null;d=null};var b2=function(co,cn){bf(function(cp){br=cp.IpList;bj=cp.AuthKey;d=cp.ExpireTime;if(co){co(cp)}},function(cp){ba.error("initIpAndAuthkey failed:"+cp.ErrorInfo);if(cn){cn(cp)}})};var cm=function(cp,cn){var co={Member_Account:bw.identifier,Limit:1000,Offset:0,GroupBaseInfoFilter:["NextMsgSeq"]};bd(co,function(ct){if(!ct.GroupIdList||ct.GroupIdList.length==0){ba.info("initMyGroupMaxSeqs: 目前还没有加入任何群组");if(cp){cp(ct)}return}for(var cr=0;cr<ct.GroupIdList.length;cr++){var cs=ct.GroupIdList[cr].GroupId;var cq=ct.GroupIdList[cr].NextMsgSeq-1;ci[cs]=cq}if(cp){cp(ct)}},function(cq){ba.error("initMyGroupMaxSeqs failed:"+cq.ErrorInfo);if(cn){cn(cq)}})};var b4=function(co,cn,cq){ck++;var cp={GroupId:co,ReqMsgSeq:cn,ReqMsgNumber:cq};ba.warn("第"+ck+"次补齐群消息,参数="+JSON.stringify(cp));ax.syncGroupMsgs(cp)};var bO=function(cn,cp){var co=ci[cn];if(co){if(cp>co){ci[cn]=cp}}else{ci[cn]=cp}};var cg=function(cp,co){for(var cq in cp){var cn=cp[cq];if(cn.From_Account){var cr=cb(cn,false,true);if(cr){co.push(cr)}bO(cn.ToGroupId,cn.MsgSeq)}}return co};var cl=function(cn,ct){var cs={};var cr=[];var co=99999999;var cu=-1;for(var cq in ct){var cv=cs[ct[cq].ToGroupId];if(!cv){cv=cs[ct[cq].ToGroupId]={min:co,max:cu,msgs:[]}}if(ct[cq].NoticeSeq>cc){ba.warn("noticeSeq="+cc+",msgNoticeSeq="+ct[cq].NoticeSeq);cc=ct[cq].NoticeSeq}ct[cq].Event=cn;cs[ct[cq].ToGroupId].msgs.push(ct[cq]);if(ct[cq].MsgSeq<cv.min){cs[ct[cq].ToGroupId].min=ct[cq].MsgSeq}if(ct[cq].MsgSeq>cv.max){cs[ct[cq].ToGroupId].max=ct[cq].MsgSeq}}for(var cp in cs){var cx=cs[cp].max-cs[cp].min+1;var cw=ci[cp];if(cw){if(cs[cp].min-cw>1||cs[cp].msgs.length<cx){ba.warn("发起一次补齐群消息请求,curMaxMsgSeq="+cw+", minMsgSeq="+cs[cp].min+", maxMsgSeq="+cs[cp].max+", msgs.length="+cs[cp].msgs.length+", tempCount="+cx);b4(cp,cs[cp].max,cs[cp].max-cw);bO(cp,cs[cp].max)}else{cr=cg(cs[cp].msgs,cr)}}else{ba.warn("不存在该群的最大消息seq，群id="+cp);if(cs[cp].msgs.length<cx){ba.warn("发起一次补齐群消息请求,minMsgSeq="+cs[cp].min+", maxMsgSeq="+cs[cp].max+", msgs.length="+cs[cp].msgs.length+", tempCount="+cx);b4(cp,cs[cp].max,cx);bO(cp,cs[cp].max)}else{cr=cg(cs[cp].msgs,cr)}}}if(cr.length){bk.updateTimeline()}if(ce&&cr.length){ce(cr)}};var bW=function(cn,ct){var cs={};var cr=[];var co=99999999;var cu=-1;for(var cq in ct){var cv=cs[ct[cq].ToGroupId];if(!cv){cv=cs[ct[cq].ToGroupId]={min:co,max:cu,msgs:[]}}if(ct[cq].NoticeSeq>cc){ba.warn("noticeSeq="+cc+",msgNoticeSeq="+ct[cq].NoticeSeq);cc=ct[cq].NoticeSeq}ct[cq].Event=cn;cs[ct[cq].ToGroupId].msgs.push(ct[cq]);if(ct[cq].MsgSeq<cv.min){cs[ct[cq].ToGroupId].min=ct[cq].MsgSeq}if(ct[cq].MsgSeq>cv.max){cs[ct[cq].ToGroupId].max=ct[cq].MsgSeq}}for(var cp in cs){var cx=cs[cp].max-cs[cp].min+1;var cw=ci[cp];if(cw){if(cs[cp].min-cw>1||cs[cp].msgs.length<cx){ba.warn("发起一次补齐群消息请求,curMaxMsgSeq="+cw+", minMsgSeq="+cs[cp].min+", maxMsgSeq="+cs[cp].max+", msgs.length="+cs[cp].msgs.length+", tempCount="+cx);b4(cp,cs[cp].max,cs[cp].max-cw);bO(cp,cs[cp].max)}else{cr=cg(cs[cp].msgs,cr)}}else{ba.warn("不存在该群的最大消息seq，群id="+cp);if(cs[cp].msgs.length<cx){ba.warn("发起一次补齐群消息请求,minMsgSeq="+cs[cp].min+", maxMsgSeq="+cs[cp].max+", msgs.length="+cs[cp].msgs.length+", tempCount="+cx);b4(cp,cs[cp].max,cx);bO(cp,cs[cp].max)}else{cr=cg(cs[cp].msgs,cr)}}}if(cr.length){bk.updateTimeline()}if(ce&&cr.length){ce(cr)}};var b0=function(cp){var co=[];for(var cr in cp){var cn=cp[cr];cn.Event=aP.GROUP_TIP;if(cn.NoticeSeq>cc){cc=cn.NoticeSeq}var cq=cb(cn,false,true);if(cq){co.push(cq)}}if(co.length){bk.updateTimeline()}if(ce&&co.length){ce(co)}};var bX=function(cw,cn){for(var cq in cw){var cA=cw[cq];var co=cA.MsgBody;var cu=co.ReportType;if(cn==false&&cA.NoticeSeq&&cA.NoticeSeq>cc){cc=cA.NoticeSeq}var cr=cA.GroupInfo.To_Account;if(cn){var cx=cA.ToGroupId+"_"+cu+"_"+co.Operator_Account;var cv=bT[cx];if(cv){ba.warn("收到重复的群系统消息：key="+cx);continue}bT[cx]=true}var cy={SrcFlag:0,ReportType:cu,GroupId:cA.ToGroupId,GroupName:cA.GroupInfo.GroupName,Operator_Account:co.Operator_Account,MsgTime:cA.MsgTimeStamp,groupReportTypeMsg:co};switch(cu){case K.JOIN_GROUP_REQUEST:cy.RemarkInfo=co.RemarkInfo;cy.MsgKey=co.MsgKey;cy.Authentication=co.Authentication;cy.UserDefinedField=cA.UserDefinedField;cy.From_Account=cA.From_Account;cy.MsgSeq=cA.ClientSeq;cy.MsgRandom=cA.MsgRandom;break;case K.JOIN_GROUP_ACCEPT:case K.JOIN_GROUP_REFUSE:cy.RemarkInfo=co.RemarkInfo;break;case K.KICK:case K.DESTORY:case K.CREATE:case K.INVITED_JOIN_GROUP_REQUEST:case K.QUIT:case K.SET_ADMIN:case K.CANCEL_ADMIN:case K.REVOKE:break;case K.READED:break;case K.CUSTOM:cy.MsgSeq=cA.MsgSeq;cy.UserDefinedField=co.UserDefinedField;break;default:ba.error("未知群系统消息类型：reportType="+cu);break}if(cn){if(cu==K.JOIN_GROUP_REQUEST){if(b6[cu]){b6[cu](cy)}}}else{if(b6[cu]){if(cu==K.READED){var ct=cy.groupReportTypeMsg.GroupReadInfoArray;for(var cs=0,cp=ct.length;cs<cp;cs++){var cz=ct[cs];b6[cu](cz)}}else{b6[cu](cy)}}}}};var b9=function(cs,cn){var cr,cq,cp;for(var co in cs){cr=cs[co];cq=cr.PushType;if(cn==false&&cr.NoticeSeq&&cr.NoticeSeq>cc){cc=cr.NoticeSeq}cp={Type:cq};switch(cq){case au.FRIEND_ADD:cp.Accounts=cr.FriendAdd_Account;break;case au.FRIEND_DELETE:cp.Accounts=cr.FriendDel_Account;break;case au.PENDENCY_ADD:cp.PendencyList=cr.PendencyAdd;break;case au.PENDENCY_DELETE:cp.Accounts=cr.FrienPencydDel_Account;break;case au.BLACK_LIST_ADD:cp.Accounts=cr.BlackListAdd_Account;break;case au.BLACK_LIST_DELETE:cp.Accounts=cr.BlackListDel_Account;break;default:ba.error("未知好友系统通知类型：friendNotice="+JSON.stringify(cr));break}if(cn){if(cq==au.PENDENCY_ADD){if(bM[cq]){bM[cq](cp)}}}else{if(bM[cq]){bM[cq](cp)}}}};var bS=function(cs,cn){var cr,cq,cp;for(var co in cs){cr=cs[co];cq=cr.PushType;if(cn==false&&cr.NoticeSeq&&cr.NoticeSeq>cc){cc=cr.NoticeSeq}cp={Type:cq};switch(cq){case aS.PROFILE_MODIFY:cp.Profile_Account=cr.Profile_Account;cp.ProfileList=cr.ProfileList;break;default:ba.error("未知资料系统通知类型：profileNotice="+JSON.stringify(cr));break}if(cn){if(cq==aS.PROFILE_MODIFY){if(b3[cq]){b3[cq](cp)}}}else{if(b3[cq]){b3[cq](cp)}}}};var bP=function(cq){var cr=cq.MsgBody;var cn=cr.ReportType;var cp=cq.GroupInfo.To_Account;var co={SrcFlag:1,ReportType:cn,GroupId:cq.ToGroupId,GroupName:cq.GroupInfo.GroupName,Operator_Account:cr.Operator_Account,MsgTime:cq.MsgTimeStamp};switch(cn){case K.JOIN_GROUP_REQUEST:co.RemarkInfo=cr.RemarkInfo;co.MsgKey=cr.MsgKey;co.Authentication=cr.Authentication;co.UserDefinedField=cq.UserDefinedField;co.From_Account=cq.From_Account;co.MsgSeq=cq.ClientSeq;co.MsgRandom=cq.MsgRandom;break;case K.JOIN_GROUP_ACCEPT:case K.JOIN_GROUP_REFUSE:co.RemarkInfo=cr.RemarkInfo;break;case K.KICK:case K.DESTORY:case K.CREATE:case K.INVITED_JOIN_GROUP_REQUEST:case K.QUIT:case K.SET_ADMIN:case K.CANCEL_ADMIN:case K.REVOKE:break;case K.CUSTOM:co.MsgSeq=cq.MsgSeq;co.UserDefinedField=cr.UserDefinedField;break;default:ba.error("未知群系统消息类型：reportType="+cn);break}if(b6[cn]){b6[cn](co)}};var ch=function(cn){for(var cp=0,co=cn.length;cp<co;cp++){b7(cn[cp])}};var b7=function(cp){var cr=cp.SubMsgType;switch(cr){case Q.READED:break;default:ba.error("未知C2c系统消息：reportType="+reportType);break}if(cp.ReadC2cMsgNotify.UinPairReadArray&&onC2cEventCallbacks[cr]){for(var co=0,cn=cp.ReadC2cMsgNotify.UinPairReadArray.length;co<cn;co++){var cq=cp.ReadC2cMsgNotify.UinPairReadArray[co];onC2cEventCallbacks[cr](cq)}}};this.longPolling=function(cq,co){var cp={Timeout:g/1000,Cookie:{NotifySeq:bL,NoticeSeq:cc}};if(ak){cp.Cookie.LongPollingId=ak;cn()}else{T({},function(cr){ak=cp.Cookie.LongPollingId=cr.LongPollingId;g=cr.Timeout>60?g:cr.Timeout*1000;cn()})}function cn(){B(cp,function(cu){for(var cr in cu.EventArray){var cs=cu.EventArray[cr];switch(cs.Event){case aP.C2C:bL=cs.NotifySeq;ba.warn("longpolling: received new c2c msg");ax.syncMsgs();break;case aP.GROUP_COMMON:ba.warn("longpolling: received new group msgs");bW(cs.Event,cs.GroupMsgArray);break;case aP.GROUP_TIP:ba.warn("longpolling: received new group tips");bW(cs.Event,cs.GroupTips);break;case aP.GROUP_SYSTEM:ba.warn("longpolling: received new group system msgs");bX(cs.GroupTips,false);break;case aP.FRIEND_NOTICE:ba.warn("longpolling: received new friend system notice");b9(cs.FriendListMod,false);break;case aP.PROFILE_NOTICE:ba.warn("longpolling: received new profile system notice");bS(cs.ProfileDataMod,false);break;case aP.C2C_COMMON:cc=cs.C2cMsgArray[0].NoticeSeq;ba.warn("longpolling: received new c2c_common msg",cc);cl(cs.Event,cs.C2cMsgArray);break;case aP.C2C_EVENT:cc=cs.C2cNotifyMsgArray[0].NoticeSeq;ba.warn("longpolling: received new c2c_event msg");ch(cs.C2cNotifyMsgArray);break;default:ba.error("longpolling收到未知新消息类型: Event="+cs.Event);break}}var ct={ActionStatus:v.OK,ErrorCode:0};cj(ct)},function(cr){cj(cr);if(co){co(cr)}})}};this.bigGroupLongPolling=function(cp,cn){var co={StartSeq:bV,HoldTime:cf,Key:ca};a0(co,function(cx){var cq=[];bV=cx.NextSeq;cf=cx.HoldTime;ca=cx.Key;if(cx.RspMsgList&&cx.RspMsgList.length>0){var cu=0,cs,ct,cw;for(var cr=cx.RspMsgList.length-1;cr>=0;cr--){cs=cx.RspMsgList[cr];if(cs.IsPlaceMsg||!cs.From_Account||!cs.MsgBody||cs.MsgBody.length==0){continue}ct=cs.Event;switch(ct){case aP.GROUP_COMMON:ba.info("bigGroupLongPolling: return new group msg");cw=cb(cs,false,false);cw&&cq.push(cw);cu=cu+1;break;case aP.GROUP_TIP:case aP.GROUP_TIP2:ba.info("bigGroupLongPolling: return new group tip");cw=cb(cs,false,false);cw&&cq.push(cw);break;case aP.GROUP_SYSTEM:ba.info("bigGroupLongPolling: new group system msg");bP(cs);break;default:ba.error("bigGroupLongPolling收到未知新消息类型: Event="+ct);break}}if(cu>0){ax.setBigGroupLongPollingMsgMap(cs.ToGroupId,cu);ba.warn("current bigGroupLongPollingMsgMap: "+JSON.stringify(bQ))}}aB=0;var cv={ActionStatus:v.OK,ErrorCode:at.ON,ErrorInfo:"connection is ok..."};aA.callBack(cv);if(cp){cp(cq)}else{if(bN){bN(cq)}}b5&&ax.bigGroupLongPolling()},function(cr){if(cr.ErrorCode!=ai){ba.error(cr.ErrorInfo);aB++}if(cr.ErrorCode!=f){ba.error("多实例登录，被kick");if(b1){b1()}}if(aB<a9){b5&&ax.bigGroupLongPolling()}else{var cq={ActionStatus:v.FAIL,ErrorCode:at.OFF,ErrorInfo:"connection is off"};aA.callBack(cq)}if(cn){cn(cr)}},cf*1000)};var cj=function(cp){if(cp.ErrorCode==0||cp.ErrorCode==ai){aI=0;E=false;var cr;var cn=false;switch(ad){case at.INIT:cn=true;ad=at.ON;cr="create connection successfully(INIT->ON)";break;case at.ON:cr="connection is on...(ON->ON)";break;case at.RECONNECT:ad=at.ON;cr="connection is on...(RECONNECT->ON)";break;case at.OFF:cn=true;ad=at.RECONNECT;cr="reconnect successfully(OFF->RECONNECT)";break}var cq={ActionStatus:v.OK,ErrorCode:ad,ErrorInfo:cr};cn&&aA.callBack(cq);bZ&&ax.longPolling()}else{if(cp.ErrorCode==f){ba.error("多实例登录，被kick");if(b1){b1()}}else{aI++;ba.warn("longPolling接口第"+aI+"次报错: "+cp.ErrorInfo);if(aI<=a9){setTimeout(bY,100)}else{ad=at.OFF;var co={ActionStatus:v.FAIL,ErrorCode:at.OFF,ErrorInfo:"connection is off"};E==false&&aA.callBack(co);E=true;ba.warn(n+"毫秒之后,SDK会发起新的longPolling请求...");setTimeout(bY,n)}}}};var cl=function(cv,cn){var cr=[];var ct=[];ct=cn;for(var cB in ct){var cq=ct[cB];var cA,cx,cu;if(cq.From_Account==bw.identifier){cA=true;cx=cq.To_Account;cu=""}else{cA=false;cx=cq.From_Account;cu=""}var cy=bk.sessByTypeId(Y.C2C,cx);if(!cy){cy=new bC(Y.C2C,cx,cx,cu,0,0)}var cs=new S(cy,cA,cq.MsgSeq,cq.MsgRandom,cq.MsgTimeStamp,cq.From_Account);var cD=null;var cp=null;var cw=null;for(var cE in cq.MsgBody){cD=cq.MsgBody[cE];cw=cD.MsgType;switch(cw){case aK.TEXT:cp=new S.Elem.Text(cD.MsgContent.Text);break;case aK.FACE:cp=new S.Elem.Face(cD.MsgContent.Index,cD.MsgContent.Data);break;case aK.IMAGE:cp=new S.Elem.Images(cD.MsgContent.UUID);for(var cz in cD.MsgContent.ImageInfoArray){var co=cD.MsgContent.ImageInfoArray[cz];cp.addImage(new S.Elem.Images.Image(co.Type,co.Size,co.Width,co.Height,co.URL))}break;case aK.SOUND:if(cD.MsgContent){cp=new S.Elem.Sound(cD.MsgContent.UUID,cD.MsgContent.Second,cD.MsgContent.Size,cq.From_Account,cq.To_Account,cD.MsgContent.Download_Flag,Y.C2C)}else{cw=aK.TEXT;cp=new S.Elem.Text("[语音消息]下载地址解析出错")}break;case aK.LOCATION:cp=new S.Elem.Location(cD.MsgContent.Longitude,cD.MsgContent.Latitude,cD.MsgContent.Desc);break;case aK.FILE:case aK.FILE+" ":cw=aK.FILE;if(cD.MsgContent){cp=new S.Elem.File(cD.MsgContent.UUID,cD.MsgContent.FileName,cD.MsgContent.FileSize,cq.From_Account,cq.To_Account,cD.MsgContent.Download_Flag,Y.C2C)}else{cw=aK.TEXT;cp=new S.Elem.Text("[文件消息下载地址解析出错]")}break;case aK.CUSTOM:try{var cF=JSON.parse(cD.MsgContent.Data);if(cF&&cF.userAction&&cF.userAction==p.ING){continue}}catch(cC){}cw=aK.CUSTOM;cp=new S.Elem.Custom(cD.MsgContent.Data,cD.MsgContent.Desc,cD.MsgContent.Ext);break;default:cw=aK.TEXT;cp=new S.Elem.Text("web端暂不支持"+cD.MsgType+"消息");break}cs.elems.push(new S.Elem(cw,cp))}if(cs.elems.length>0&&bk.addMsg(cs)){cr.push(cs)}}if(cr.length>0){bk.updateTimeline()}if(cr.length>0){if(ce){ce(cr)}}};var bY=function(){bZ&&ax.longPolling()};var b8=function(cn){for(var co in cn){var cp=cn[co];switch(cp.Event){case aP.GROUP_SYSTEM:ba.warn("handlerApplyJoinGroupSystemMsgs： handler new group system msg");bX(cp.GroupTips,true);break;default:ba.error("syncMsgs收到未知的群系统消息类型: Event="+cp.Event);break}}};this.syncMsgs=function(cq,co){var cp=[];var cn=[];aX(bk.cookie,bk.syncFlag,function(cv){if(cv.SyncFlag==2){bk.syncFlag=0}cn=cv.MsgList;bk.cookie=cv.Cookie;for(var cA in cn){var cG=cn[cA];var cw,cs,cr;if(cG.From_Account==bw.identifier){cw=true;cs=cG.To_Account;cr=""}else{cw=false;cs=cG.From_Account;cr=""}var cF=bk.sessByTypeId(Y.C2C,cs);if(!cF){cF=new bC(Y.C2C,cs,cs,cr,0,0)}var ct=new S(cF,cw,cG.MsgSeq,cG.MsgRandom,cG.MsgTimeStamp,cG.From_Account);var cu=null;var cy=null;var cB=null;for(var cC in cG.MsgBody){cu=cG.MsgBody[cC];cB=cu.MsgType;switch(cB){case aK.TEXT:cy=new S.Elem.Text(cu.MsgContent.Text);break;case aK.FACE:cy=new S.Elem.Face(cu.MsgContent.Index,cu.MsgContent.Data);break;case aK.IMAGE:cy=new S.Elem.Images(cu.MsgContent.UUID);for(var cx in cu.MsgContent.ImageInfoArray){var cE=cu.MsgContent.ImageInfoArray[cx];cy.addImage(new S.Elem.Images.Image(cE.Type,cE.Size,cE.Width,cE.Height,cE.URL))}break;case aK.SOUND:if(cu.MsgContent){cy=new S.Elem.Sound(cu.MsgContent.UUID,cu.MsgContent.Second,cu.MsgContent.Size,cG.From_Account,cG.To_Account,cu.MsgContent.Download_Flag,Y.C2C)}else{cB=aK.TEXT;cy=new S.Elem.Text("[语音消息]下载地址解析出错")}break;case aK.LOCATION:cy=new S.Elem.Location(cu.MsgContent.Longitude,cu.MsgContent.Latitude,cu.MsgContent.Desc);break;case aK.FILE:case aK.FILE+" ":cB=aK.FILE;if(cu.MsgContent){cy=new S.Elem.File(cu.MsgContent.UUID,cu.MsgContent.FileName,cu.MsgContent.FileSize,cG.From_Account,cG.To_Account,cu.MsgContent.Download_Flag,Y.C2C)}else{cB=aK.TEXT;cy=new S.Elem.Text("[文件消息下载地址解析出错]")}break;case aK.CUSTOM:try{var cz=JSON.parse(cu.MsgContent.Data);if(cz&&cz.userAction&&cz.userAction==p.ING){continue}}catch(cD){}cB=aK.CUSTOM;cy=new S.Elem.Custom(cu.MsgContent.Data,cu.MsgContent.Desc,cu.MsgContent.Ext);break;default:cB=aK.TEXT;cy=new S.Elem.Text("web端暂不支持"+cu.MsgType+"消息");break}ct.elems.push(new S.Elem(cB,cy))}if(ct.elems.length>0&&bk.addMsg(ct)){cp.push(ct)}}b8(cv.EventArray);if(cp.length>0){bk.updateTimeline()}if(cq){cq(cp)}else{if(cp.length>0){if(ce){ce(cp)}}}},function(cr){ba.error("getMsgs failed:"+cr.ErrorInfo);if(co){co(cr)}})};this.getC2CHistoryMsgs=function(cn,cq,co){if(!cn.Peer_Account){if(co){co(af.getReturnError("Peer_Account is empty",-13));return}}if(!cn.MaxCnt){cn.MaxCnt=15}if(cn.MaxCnt<=0){if(co){co(af.getReturnError("MaxCnt should be greater than 0",-14));return}}if(cn.MaxCnt>15){if(co){co(af.getReturnError("MaxCnt can not be greater than 15",-15));return}return}if(cn.MsgKey==null||cn.MsgKey===undefined){cn.MsgKey=""}var cp={Peer_Account:cn.Peer_Account,MaxCnt:cn.MaxCnt,LastMsgTime:cn.LastMsgTime,MsgKey:cn.MsgKey};W(cp,function(cv){var cC=[];var cG=[];cG=cv.MsgList;var cF=bk.sessByTypeId(Y.C2C,cn.Peer_Account);if(!cF){cF=new bC(Y.C2C,cn.Peer_Account,cn.Peer_Account,"",0,0)}for(var cz in cG){var cH=cG[cz];var cw,cs,cr;if(cH.From_Account==bw.identifier){cw=true;cs=cH.To_Account;cr=""}else{cw=false;cs=cH.From_Account;cr=""}var ct=new S(cF,cw,cH.MsgSeq,cH.MsgRandom,cH.MsgTimeStamp,cH.From_Account);var cu=null;var cy=null;var cA=null;for(var cB in cH.MsgBody){cu=cH.MsgBody[cB];cA=cu.MsgType;switch(cA){case aK.TEXT:cy=new S.Elem.Text(cu.MsgContent.Text);break;case aK.FACE:cy=new S.Elem.Face(cu.MsgContent.Index,cu.MsgContent.Data);break;case aK.IMAGE:cy=new S.Elem.Images(cu.MsgContent.UUID);for(var cx in cu.MsgContent.ImageInfoArray){var cD=cu.MsgContent.ImageInfoArray[cx];cy.addImage(new S.Elem.Images.Image(cD.Type,cD.Size,cD.Width,cD.Height,cD.URL))}break;case aK.SOUND:if(cu.MsgContent){cy=new S.Elem.Sound(cu.MsgContent.UUID,cu.MsgContent.Second,cu.MsgContent.Size,cH.From_Account,cH.To_Account,cu.MsgContent.Download_Flag,Y.C2C)}else{cA=aK.TEXT;cy=new S.Elem.Text("[语音消息]下载地址解析出错")}break;case aK.LOCATION:cy=new S.Elem.Location(cu.MsgContent.Longitude,cu.MsgContent.Latitude,cu.MsgContent.Desc);break;case aK.FILE:case aK.FILE+" ":cA=aK.FILE;if(cu.MsgContent){cy=new S.Elem.File(cu.MsgContent.UUID,cu.MsgContent.FileName,cu.MsgContent.FileSize,cH.From_Account,cH.To_Account,cu.MsgContent.Download_Flag,Y.C2C)}else{cA=aK.TEXT;cy=new S.Elem.Text("[文件消息下载地址解析出错]")}break;case aK.CUSTOM:cA=aK.CUSTOM;cy=new S.Elem.Custom(cu.MsgContent.Data,cu.MsgContent.Desc,cu.MsgContent.Ext);break;default:cA=aK.TEXT;cy=new S.Elem.Text("web端暂不支持"+cu.MsgType+"消息");break}ct.elems.push(new S.Elem(cA,cy))}bk.addMsg(ct);cC.push(ct)}bk.updateTimeline();if(cq){var cE={Complete:cv.Complete,MsgCount:cC.length,LastMsgTime:cv.LastMsgTime,MsgKey:cv.MsgKey,MsgList:cC};cF.isFinished(cv.Complete);cq(cE)}},function(cr){ba.error("getC2CHistoryMsgs failed:"+cr.ErrorInfo);if(co){co(cr)}})};this.syncGroupMsgs=function(co,cs,cq){if(co.ReqMsgSeq<=0){if(cq){var cp="ReqMsgSeq must be greater than 0";var cn=af.getReturnError(cp,-16);cq(cn)}return}var cr={GroupId:co.GroupId,ReqMsgSeq:co.ReqMsgSeq,ReqMsgNumber:co.ReqMsgNumber};aE(cr,function(cA){var cx=[];var cw=cA.GroupId;var ct=cA.RspMsgList;var cy=cA.IsFinished;if(ct==null||ct===undefined){if(cs){cs([])}return}for(var cv=ct.length-1;cv>=0;cv--){var cu=ct[cv];if(cu.IsPlaceMsg||!cu.From_Account||!cu.MsgBody||cu.MsgBody.length==0){continue}var cz=cb(cu,true,true,cy);if(cz){cx.push(cz)}}if(cx.length>0){bk.updateTimeline()}if(cs){cs(cx)}else{if(cx.length>0){if(ce){ce(cx)}}}},function(ct){ba.error("getGroupMsgs failed:"+ct.ErrorInfo);if(cq){cq(ct)}})};var cb=function(cu,cz,cR,cq){if(cu.IsPlaceMsg||!cu.From_Account||!cu.MsgBody||cu.MsgBody.length==0){return null}var cJ,cC,cx,cD;var cH=cu.ToGroupId;var ct=cH;if(cu.GroupInfo){if(cu.GroupInfo.GroupName){ct=cu.GroupInfo.GroupName}}cD=cu.From_Account;if(cu.GroupInfo){if(cu.GroupInfo.From_AccountNick){cD=cu.GroupInfo.From_AccountNick}}if(cu.From_Account==bw.identifier){cJ=true;cC=cu.From_Account;cx=""}else{cJ=false;cC=cu.From_Account;cx=""}var cG=bk.sessByTypeId(Y.GROUP,cH);if(!cG){cG=new bC(Y.GROUP,cH,ct,cx,0,0)}if(typeof cq!=="undefined"){cG.isFinished(cq||0)}var cO=aH.COMMON;if(aP.GROUP_TIP==cu.Event||aP.GROUP_TIP2==cu.Event){cO=aH.TIP;var cw=cu.MsgBody;cu.MsgBody=[];cu.MsgBody.push({MsgType:aK.GROUP_TIP,MsgContent:cw})}else{if(cu.MsgPriority){if(cu.MsgPriority==z.REDPACKET){cO=aH.REDPACKET}else{if(cu.MsgPriority==z.LOVEMSG){cO=aH.LOVEMSG}}}}var cv=new S(cG,cJ,cu.MsgSeq,cu.MsgRandom,cu.MsgTimeStamp,cu.From_Account,cO,cD);var cP=null;var cp=null;var cA=null;for(var cQ in cu.MsgBody){cP=cu.MsgBody[cQ];cA=cP.MsgType;switch(cA){case aK.TEXT:cp=new S.Elem.Text(cP.MsgContent.Text);break;case aK.FACE:cp=new S.Elem.Face(cP.MsgContent.Index,cP.MsgContent.Data);break;case aK.IMAGE:cp=new S.Elem.Images(cP.MsgContent.UUID);for(var cI in cP.MsgContent.ImageInfoArray){cp.addImage(new S.Elem.Images.Image(cP.MsgContent.ImageInfoArray[cI].Type,cP.MsgContent.ImageInfoArray[cI].Size,cP.MsgContent.ImageInfoArray[cI].Width,cP.MsgContent.ImageInfoArray[cI].Height,cP.MsgContent.ImageInfoArray[cI].URL))}break;case aK.SOUND:if(cP.MsgContent){cp=new S.Elem.Sound(cP.MsgContent.UUID,cP.MsgContent.Second,cP.MsgContent.Size,cu.From_Account,cu.To_Account,cP.MsgContent.Download_Flag,Y.GROUP)}else{cA=aK.TEXT;cp=new S.Elem.Text("[语音消息]下载地址解析出错")}break;case aK.LOCATION:cp=new S.Elem.Location(cP.MsgContent.Longitude,cP.MsgContent.Latitude,cP.MsgContent.Desc);break;case aK.FILE:case aK.FILE+" ":cA=aK.FILE;var cy=j(cP.MsgContent.UUID,cu.From_Account,cP.MsgContent.FileName);if(cP.MsgContent){cp=new S.Elem.File(cP.MsgContent.UUID,cP.MsgContent.FileName,cP.MsgContent.FileSize,cu.From_Account,cu.To_Account,cP.MsgContent.Download_Flag,Y.GROUP)}else{cA=aK.TEXT;cp=new S.Elem.Text("[文件消息]地址解析出错")}break;case aK.GROUP_TIP:var cs=cP.MsgContent.OpType;cp=new S.Elem.GroupTip(cs,cP.MsgContent.Operator_Account,cH,cu.GroupInfo.GroupName,cP.MsgContent.List_Account);if(h.JOIN==cs||h.QUIT==cs){cp.setGroupMemberNum(cP.MsgContent.MemberNum)}else{if(h.MODIFY_GROUP_INFO==cs){var cN=false;var cF={GroupId:cH,GroupFaceUrl:null,GroupName:null,OwnerAccount:null,GroupNotification:null,GroupIntroduction:null};var cS=cP.MsgContent.MsgGroupNewInfo;if(cS.GroupFaceUrl){var cL=new S.Elem.GroupTip.GroupInfo(aU.FACE_URL,cS.GroupFaceUrl);cp.addGroupInfo(cL);cN=true;cF.GroupFaceUrl=cS.GroupFaceUrl}if(cS.GroupName){var co=new S.Elem.GroupTip.GroupInfo(aU.NAME,cS.GroupName);cp.addGroupInfo(co);cN=true;cF.GroupName=cS.GroupName}if(cS.Owner_Account){var cB=new S.Elem.GroupTip.GroupInfo(aU.OWNER,cS.Owner_Account);cp.addGroupInfo(cB);cN=true;cF.OwnerAccount=cS.Owner_Account}if(cS.GroupNotification){var cr=new S.Elem.GroupTip.GroupInfo(aU.NOTIFICATION,cS.GroupNotification);cp.addGroupInfo(cr);cN=true;cF.GroupNotification=cS.GroupNotification}if(cS.GroupIntroduction){var cK=new S.Elem.GroupTip.GroupInfo(aU.INTRODUCTION,cS.GroupIntroduction);cp.addGroupInfo(cK);cN=true;cF.GroupIntroduction=cS.GroupIntroduction}if(cz==false&&cN&&bU){bU(cF)}}else{if(h.MODIFY_MEMBER_INFO==cs){var cM=cP.MsgContent.MsgMemberInfo;for(var cE in cM){var cn=cM[cE];cp.addMemberInfo(new S.Elem.GroupTip.MemberInfo(cn.User_Account,cn.ShutupTime))}}}}break;case aK.CUSTOM:cA=aK.CUSTOM;cp=new S.Elem.Custom(cP.MsgContent.Data,cP.MsgContent.Desc,cP.MsgContent.Ext);break;default:cA=aK.TEXT;cp=new S.Elem.Text("web端暂不支持"+cP.MsgType+"消息");break}cv.elems.push(new S.Elem(cA,cp))}if(cR==false){return cv}if(bk.addMsg(cv)){return cv}else{return null}};this.init=function(co,cq,cn){if(!co.onMsgNotify){ba.warn("listeners.onMsgNotify is empty")}ce=co.onMsgNotify;if(co.onBigGroupMsgNotify){bN=co.onBigGroupMsgNotify}else{ba.warn("listeners.onBigGroupMsgNotify is empty")}if(co.onC2cEventNotifys){onC2cEventCallbacks=co.onC2cEventNotifys}else{ba.warn("listeners.onC2cEventNotifys is empty")}if(co.onGroupSystemNotifys){b6=co.onGroupSystemNotifys}else{ba.warn("listeners.onGroupSystemNotifys is empty")}if(co.onGroupInfoChangeNotify){bU=co.onGroupInfoChangeNotify}else{ba.warn("listeners.onGroupInfoChangeNotify is empty")}if(co.onFriendSystemNotifys){bM=co.onFriendSystemNotifys}else{ba.warn("listeners.onFriendSystemNotifys is empty")}if(co.onProfileSystemNotifys){b3=co.onProfileSystemNotifys}else{ba.warn("listeners.onProfileSystemNotifys is empty")}if(co.onKickedEventCall){b1=co.onKickedEventCall}else{ba.warn("listeners.onKickedEventCall is empty")}if(co.onAppliedDownloadUrl){onAppliedDownloadUrl=co.onAppliedDownloadUrl}else{ba.warn("listeners.onAppliedDownloadUrl is empty")}if(!bw.identifier||!bw.userSig){if(cq){var cp={ActionStatus:v.OK,ErrorCode:0,ErrorInfo:"login success(no login state)"};cq(cp)}return}cm(function(cr){ba.info("initMyGroupMaxSeqs success");b2(function(cs){ba.info("initIpAndAuthkey success");if(cq){ba.info("login success(have login state))");var ct={ActionStatus:v.OK,ErrorCode:0,ErrorInfo:"login success"};cq(ct)}ax.setLongPollingOn(true);bZ&&ax.longPolling(cq)},cn)},cn)};this.sendMsg=function(co,cp,cn){aw(co,function(cs){if(co.sess.type()==Y.C2C){if(!bk.addMsg(co)){var cr="sendMsg: addMsg failed!";var cq=af.getReturnError(cr,-17);ba.error(cr);if(cn){cn(cq)}return}bk.updateTimeline()}if(cp){cp(cs)}},function(cq){if(cn){cn(cq)}})}};var a2=new function(){this.fileMd5=null;var bL=function(bN,bP,bM){var bQ=null;try{bQ=new FileReader()}catch(bU){if(bM){bM(af.getReturnError("当前浏览器不支持FileReader",-18));return}}var bW=File.prototype.mozSlice||File.prototype.webkitSlice||File.prototype.slice;if(!bW){if(bM){bM(af.getReturnError("当前浏览器不支持FileAPI",-19));return}}var bO=2*1024*1024;var bR=Math.ceil(bN.size/bO);var bV=0;var bS=new SparkMD5();bQ.onload=function(b1){var b0="";var bX=new Uint8Array(b1.target.result);var bZ=bX.byteLength;for(var bY=0;bY<bZ;bY++){b0+=String.fromCharCode(bX[bY])}bS.appendBinary(b0);bV++;if(bV<bR){bT()}else{this.fileMd5=bS.end();if(bP){bP(this.fileMd5)}}};function bT(){var bZ=bV*bO,bY=bZ+bO>=bN.size?bN.size:bZ+bO;var bX=bW.call(bN,bZ,bY);bQ.readAsArrayBuffer(bX)}bT()};this.submitUploadFileForm=function(bP,bV,bQ){var bZ;var bX;var b2=bP.formId;var b1=bP.fileId;var b0=A++;var bN="uploadResultIframe_"+b0;var bU=bP.To_Account;var bR=bP.businessType;var bM=document.getElementById(b2);if(!bM){bZ="获取表单对象为空: formId="+b2+"(formId非法)";bX=af.getReturnError(bZ,-20);if(bQ){bQ(bX)}return}var bY=document.getElementById(b1);if(!bY){bZ="获取文件对象为空: fileId="+b1+"(没有选择文件或者fileId非法)";bX=af.getReturnError(bZ,-21);if(bQ){bQ(bX)}return}bY.name="file";var bS=document.createElement("iframe");bS.name=bN;bS.id=bN;bS.style.display="none";document.body.appendChild(bS);var bT;if(s()){bT="pic_up"}else{bT="pic_up_test"}var bO="https://pic.tim.qq.com/v4/openpic/"+bT+"?tinyid="+bw.tinyid+"&a2="+bw.a2+"&sdkappid="+bw.sdkAppID+"&accounttype="+bw.accountType+"&contenttype=http";bM.action=bO;bM.method="post";bM.target=bN;function b3(b5,b6){var b4=document.createElement("input");b4.type="hidden";b4.name=b5;b4.value=b6;bM.appendChild(b4)}b3("App_Version",ac.APP_VERSION);b3("From_Account",bw.identifier);b3("To_Account",bU);b3("Seq",G().toString());b3("Timestamp",aJ().toString());b3("Random",bg().toString());b3("Busi_Id",bR);b3("PkgFlag",a3.RAW_DATA.toString());b3("Auth_Key",bj);b3("Server_Ver",ac.SERVER_VERSION.toString());b3("File_Type",bP.fileType);function bW(){var b5;try{b5=JSON.parse(bS.contentWindow.name)||{}}catch(b4){b5={}}if(b5.ActionStatus){bS.src="about:blank";bS.parentNode.removeChild(bS);bS=null;if(b5.ActionStatus==v.OK){bV&&bV(b5)}else{bQ&&bQ(b5)}}else{setTimeout(bW,100)}}setTimeout(bW,500);bM.submit()};this.uploadFile=function(bN,bP,bO){var bM={init:function(bQ,bT,bR){var bS=this;bS.file=bQ.file;bS.onProgressCallBack=bQ.onProgressCallBack;if(bQ.abortButton){bQ.abortButton.onclick=bS.abortHandler}bS.total=bS.file.size;bS.loaded=0;bS.step=1080*1024;bS.sliceSize=0;bS.sliceOffset=0;bS.timestamp=aJ();bS.seq=G();bS.random=bg();bS.fromAccount=bw.identifier;bS.toAccount=bQ.To_Account;bS.fileMd5=bQ.fileMd5;bS.businessType=bQ.businessType;bS.fileType=bQ.fileType;bS.cbOk=bT;bS.cbErr=bR;bS.reader=new FileReader();bS.blobSlice=File.prototype.mozSlice||File.prototype.webkitSlice||File.prototype.slice;bS.reader.onloadstart=bS.onLoadStart;bS.reader.onprogress=bS.onProgress;bS.reader.onabort=bS.onAbort;bS.reader.onerror=bS.onerror;bS.reader.onload=bS.onLoad;bS.reader.onloadend=bS.onLoadEnd},upload:function(){var bQ=bM;bQ.readBlob(0)},onLoadStart:function(){var bQ=bM},onProgress:function(bR){var bQ=bM;bQ.loaded+=bR.loaded;if(bQ.onProgressCallBack){bQ.onProgressCallBack(bQ.loaded,bQ.total)}},onAbort:function(){var bQ=bM},onError:function(){var bQ=bM},onLoad:function(bV){var bT=bM;if(bV.target.readyState==FileReader.DONE){var bS=bV.target.result;var bW=bS.indexOf(",");if(bW!=-1){bS=bS.substr(bW+1)}var bR={From_Account:bT.fromAccount,To_Account:bT.toAccount,Busi_Id:bT.businessType,File_Type:bT.fileType,File_Str_Md5:bT.fileMd5,PkgFlag:a3.BASE64_DATA,File_Size:bT.total,Slice_Offset:bT.sliceOffset,Slice_Size:bT.sliceSize,Slice_Data:bS,Seq:bT.seq,Timestamp:bT.timestamp,Random:bT.random};var bU=function(bX){if(bX.IsFinish==0){bT.loaded=bX.Next_Offset;if(bT.loaded<bT.total){bT.readBlob(bT.loaded)}else{bT.loaded=bT.total}}else{if(bT.cbOk){var bY={ActionStatus:bX.ActionStatus,ErrorCode:bX.ErrorCode,ErrorInfo:bX.ErrorInfo,File_UUID:bX.File_UUID,File_Size:bX.Next_Offset,URL_INFO:bX.URL_INFO,Download_Flag:bX.Download_Flag};if(bT.fileType==P.FILE){bY.URL_INFO=j(bX.File_UUID,bw.identifier,bT.file.name)}bT.cbOk(bY)}}ap=0};var bQ=function(bX){if(ap<aR){ap++;setTimeout(function(){ae(bR,bU,bQ)},1000)}else{bT.cbErr(bX)}};ae(bR,bU,bQ)}},onLoadEnd:function(){var bQ=bM},readBlob:function(bU){var bT=bM;var bR,bS=bT.file;var bQ=bU+bT.step;if(bQ>bT.total){bQ=bT.total;bT.sliceSize=bQ-bU}else{bT.sliceSize=bT.step}bT.sliceOffset=bU;bR=bT.blobSlice.call(bS,bU,bQ);bT.reader.readAsDataURL(bR)},abortHandler:function(){var bQ=bM;if(bQ.reader){bQ.reader.abort()}}};bL(bN.file,function(bQ){ba.info("fileMd5: "+bQ);bN.fileMd5=bQ;bM.init(bN,bP,bO);bM.upload()},bO)}};aV.SESSION_TYPE=Y;aV.MSG_MAX_LENGTH=bD;aV.C2C_MSG_SUB_TYPE=a1;aV.GROUP_MSG_SUB_TYPE=aH;aV.MSG_ELEMENT_TYPE=aK;aV.GROUP_TIP_TYPE=h;aV.IMAGE_TYPE=aG;aV.GROUP_SYSTEM_TYPE=K;aV.FRIEND_NOTICE_TYPE=au;aV.GROUP_TIP_MODIFY_GROUP_INFO_TYPE=aU;aV.BROWSER_INFO=a8;aV.Emotions=aV.EmotionPicData=bn;aV.EmotionDataIndexs=aV.EmotionPicDataIndex=bo;aV.TLS_ERROR_CODE=bF;aV.CONNECTION_STATUS=at;aV.UPLOAD_PIC_BUSSINESS_TYPE=bq;aV.RECENT_CONTACT_TYPE=bc;aV.UPLOAD_RES_TYPE=P;aV.Tool=af;aV.Log=ba;aV.Msg=S;aV.Session=bC;aV.MsgStore={sessMap:function(){return bk.sessMap()},sessCount:function(){return bk.sessCount()},sessByTypeId:function(bL,bM){return bk.sessByTypeId(bL,bM)},delSessByTypeId:function(bL,bM){return bk.delSessByTypeId(bL,bM)},resetCookieAndSyncFlag:function(){return bk.resetCookieAndSyncFlag()}};aV.Resources=bx;aV.login=aV.init=function(bL,bN,bO,bP,bM){aA.init(bN.onConnNotify,bP,bM);if(bN.jsonpCallback){a7=bN.jsonpCallback}bl(bL,bN,bO,bP,bM)};aV.logout=aV.offline=function(bM,bL){return bu("instance",bM,bL)};aV.logoutAll=function(bM,bL){return bu("all",bM,bL)};aV.sendMsg=function(bM,bN,bL){return ax.sendMsg(bM,bN,bL)};aV.syncMsgs=function(bM,bL){return ax.syncMsgs(bM,bL)};aV.getC2CHistoryMsgs=function(bL,bN,bM){return ax.getC2CHistoryMsgs(bL,bN,bM)};aV.syncGroupMsgs=function(bL,bN,bM){return ax.syncGroupMsgs(bL,bN,bM)};aV.c2CMsgReaded=function(bL,bN,bM){return bk.c2CMsgReaded(bL,bN,bM)};aV.groupMsgReaded=function(bL,bN,bM){return bz(bL,bN,bM)};aV.setAutoRead=function(bM,bN,bL){return bk.setAutoRead(bM,bN,bL)};aV.createGroup=function(bL,bN,bM){return aW(bL,bN,bM)};aV.createGroupHigh=function(bL,bN,bM){return ay(bL,bN,bM)};aV.applyJoinGroup=function(bL,bN,bM){return aC(bL,bN,bM)};aV.handleApplyJoinGroupPendency=function(bL,bN,bM){return o(bL,bN,bM)};aV.deleteApplyJoinGroupPendency=function(bL,bN,bM){return bK(bL,bN,bM)};aV.quitGroup=function(bL,bN,bM){return aD(bL,bN,bM)};aV.searchGroupByName=function(bL,bN,bM){return M(bL,bN,bM)};aV.getGroupPublicInfo=function(bL,bN,bM){return e(bL,bN,bM)};aV.getGroupInfo=function(bL,bN,bM){return V(bL,bN,bM)};aV.modifyGroupBaseInfo=function(bL,bN,bM){return bh(bL,bN,bM)};aV.getGroupMemberInfo=function(bL,bN,bM){return bi(bL,bN,bM)};aV.addGroupMember=function(bL,bN,bM){return t(bL,bN,bM)};aV.modifyGroupMember=function(bL,bN,bM){return m(bL,bN,bM)};aV.deleteGroupMember=function(bL,bN,bM){return aT(bL,bN,bM)};aV.destroyGroup=function(bL,bN,bM){return an(bL,bN,bM)};aV.changeGroupOwner=function(bL,bN,bM){return c(bL,bN,bM)};aV.getJoinedGroupListHigh=function(bL,bN,bM){return bd(bL,bN,bM)};aV.getRoleInGroup=function(bL,bN,bM){return D(bL,bN,bM)};aV.forbidSendMsg=function(bL,bN,bM){return y(bL,bN,bM)};aV.sendCustomGroupNotify=function(bL,bN,bM){return F(bL,bN,bM)};aV.applyJoinBigGroup=function(bL,bN,bM){return be(bL,bN,bM)};aV.quitBigGroup=function(bL,bN,bM){return bB(bL,bN,bM)};aV.getProfilePortrait=function(bL,bN,bM){return al(bL,bN,bM)};aV.setProfilePortrait=function(bL,bN,bM){return bb(bL,bN,bM)};aV.applyAddFriend=function(bL,bN,bM){return aY(bL,bN,bM)};aV.getPendency=function(bL,bN,bM){return r(bL,bN,bM)};aV.deletePendency=function(bL,bN,bM){return ag(bL,bN,bM)};aV.responseFriend=function(bL,bN,bM){return Z(bL,bN,bM)};aV.getAllFriend=function(bL,bN,bM){return bp(bL,bN,bM)};aV.deleteFriend=function(bL,bN,bM){return I(bL,bN,bM)};aV.addBlackList=function(bL,bN,bM){return l(bL,bN,bM)};aV.deleteBlackList=function(bL,bN,bM){return am(bL,bN,bM)};aV.getBlackList=function(bL,bN,bM){return x(bL,bN,bM)};aV.getRecentContactList=function(bL,bN,bM){return aF(bL,bN,bM)};aV.uploadFile=aV.uploadPic=function(bL,bN,bM){return a2.uploadFile(bL,bN,bM)};aV.submitUploadFileForm=function(bL,bN,bM){return a2.submitUploadFileForm(bL,bN,bM)};aV.uploadFileByBase64=aV.uploadPicByBase64=function(bL,bO,bN){var bM={To_Account:bL.toAccount,Busi_Id:bL.businessType,File_Type:bL.File_Type,File_Str_Md5:bL.fileMd5,PkgFlag:a3.BASE64_DATA,File_Size:bL.totalSize,Slice_Offset:0,Slice_Size:bL.totalSize,Slice_Data:bL.base64Str,Seq:G(),Timestamp:aJ(),Random:bg()};return ae(bM,bO,bN)};aV.setJsonpLastRspData=function(bL){av=typeof(bL)=="string"?JSON.parse(bL):bL};aV.getLongPollingId=function(bL,bN,bM){return T(bL,bN,bM)};aV.applyDownload=function(bL,bN,bM){return U(bL,bN,bM)};aV.onDownFile=function(bL){window.open(bx.downloadMap["uuid_"+bL])};aV.checkLogin=function(bL,bM){return bm(bL,bM)}})(b);return b}();